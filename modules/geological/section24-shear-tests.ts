/**
 * Файл: section24-shear-tests.ts
 * Назначение: Испытания грунтов срезом и сдвигом
 */

import type { 
  InstructionBlock, 
  GeologicalInput, 
  WorkItem 
} from './types';

/**
 * Блок 24.1: Полевые срезные испытания
 */
export const block_24_01_field_shear: InstructionBlock = {
  id: 'block-24-01-field-shear',
  section: 'Раздел 24: Срезные испытания',
  title: 'Полевые испытания грунтов срезом',
  description: 'Определение прочностных характеристик в массиве',
  priority: 40,
  tags: ['полевые', 'срез', 'прочность', 'откосы'],
  
  condition: (input: GeologicalInput) => {
    return (input.hasSlopes === true ||
            input.requiresShearStrength === true ||
            input.soilTypes?.includes('глинистые')) &&
           input.geotechnicalCategory !== 'I';
  },
  
  variants: [
    {
      id: 'variant-field-shear',
      priority: 'РЕКОМЕНДУЕМЫЙ',
      normative: {
        document: 'ГОСТ 20276-2012',
        section: 'Испытания срезом',
        priority: 'РЕКОМЕНДУЕМЫЙ'
      },
      recommendation:
        '**ПОЛЕВЫЕ СРЕЗНЫЕ ИСПЫТАНИЯ:**\n\n' +
        
        '**1. НАЗНАЧЕНИЕ:**\n' +
        '- Определение φ (угол внутреннего трения)\n' +
        '- Определение c (удельное сцепление)\n' +
        '- Испытания ненарушенного массива\n' +
        '- Для проектирования откосов, подпорных стен\n' +
        '- Контроль устойчивости склонов\n\n' +
        
        '**2. ПРИНЦИП МЕТОДА:**\n' +
        '- Выделение призмы грунта\n' +
        '- Приложение вертикальной нагрузки σ\n' +
        '- Приложение горизонтальной сдвигающей силы τ\n' +
        '- Доведение до разрушения (срыва)\n' +
        '- Повторение при разных σ\n\n' +
        
        '**3. ТИПЫ УСТАНОВОК:**\n\n' +
        
        '**А. Целик (монолит):**\n' +
        '- Призма 0.4×0.4 м, высота 0.5 м\n' +
        '- Выделяется в шурфе или котловане\n' +
        '- Зачистка боковых стенок\n' +
        '- Нагружение сверху + сдвиг\n\n' +
        
        '**Б. Штамп со срезной площадкой:**\n' +
        '- Круглый штамп с зубьями\n' +
        '- Втапливание в грунт\n' +
        '- Срез по кольцевой площадке\n\n' +
        
        '**В. Крыльчатка (вейнтест):**\n' +
        '- Для слабых глинистых грунтов\n' +
        '- Вращение лопастей в скважине\n' +
        '- Экспресс-метод\n\n' +
        
        '**4. МЕТОДИКА (монолит):**\n\n' +
        
        '**Подготовка:**\n' +
        '- Отрывка шурфа 2×2 м, глубина 2 м\n' +
        '- Выделение целика 0.4×0.4 м\n' +
        '- Подрезка на глубину 0.5 м\n' +
        '- Зачистка боковых стенок\n' +
        '- Установка рамы и штампа\n\n' +
        
        '**Нагружение:**\n' +
        '- 3-5 опытов с разными σ:\n' +
        '  σ₁ = 0.1 МПа\n' +
        '  σ₂ = 0.2 МПа\n' +
        '  σ₃ = 0.3 МПа\n' +
        '- Выдержка под σ: 30 мин\n' +
        '- Сдвиг со скоростью 0.5-1.0 мм/мин\n' +
        '- До разрушения (срыв целика)\n\n' +
        
        '**5. ОБРАБОТКА РЕЗУЛЬТАТОВ:**\n\n' +
        
        '**График τ - Δ (сдвиг):**\n' +
        '- τ - касательное напряжение\n' +
        '- Δ - горизонтальное смещение\n' +
        '- Определение τmax для каждого опыта\n\n' +
        
        '**График τmax - σ (паспорт прочности):**\n' +
        '```\n' +
        'τ = c + σ × tg(φ)\n' +
        '\n' +
        'Прямая линия (закон Кулона):\n' +
        'c - отрезок на оси τ (сцепление)\n' +
        'tg(φ) - угол наклона (тангенс угла трения)\n' +
        '```\n\n' +
        
        '**6. ТИПИЧНЫЕ ЗНАЧЕНИЯ:**\n\n' +
        
        '**Песчаные грунты:**\n' +
        '- Пески гравелистые: φ = 38-43°, c = 0\n' +
        '- Пески крупные: φ = 35-40°, c = 0-2 кПа\n' +
        '- Пески средние: φ = 30-35°, c = 0-3 кПа\n' +
        '- Пески мелкие: φ = 28-32°, c = 2-5 кПа\n' +
        '- Пески пылеватые: φ = 24-28°, c = 3-8 кПа\n\n' +
        
        '**Глинистые грунты:**\n' +
        '- Супеси: φ = 18-24°, c = 10-20 кПа\n' +
        '- Суглинки: φ = 15-22°, c = 15-40 кПа\n' +
        '- Глины: φ = 10-18°, c = 30-80 кПа\n\n' +
        
        '**Зависимость от консистенции (глины):**\n' +
        '- Полутвёрдые (IL < 0): φ = 18-25°, c = 50-100 кПа\n' +
        '- Тугопластичные (0 < IL < 0.25): φ = 15-20°, c = 30-60 кПа\n' +
        '- Мягкопластичные (0.5 < IL < 0.75): φ = 12-16°, c = 15-30 кПа\n' +
        '- Текучие (IL > 1): φ = 8-12°, c = 5-15 кПа\n\n' +
        
        '**7. КОЛИЧЕСТВО ИСПЫТАНИЙ:**\n' +
        '- 3-5 опытов (при разных σ) на одном целике\n' +
        '- 2-3 целика на каждый ИГЭ\n' +
        '- Всего: 6-15 опытов на ИГЭ\n\n' +
        
        '**8. ПРЕИМУЩЕСТВА:**\n' +
        '- Испытания в естественном залегании\n' +
        '- Учёт природной структуры\n' +
        '- Прямое определение φ и c\n' +
        '- Применимо для всех грунтов\n\n' +
        
        '**9. НЕДОСТАТКИ:**\n' +
        '- Трудоёмкость\n' +
        '- Необходимость отрывки шурфов\n' +
        '- Сложность на глубине\n' +
        '- Влияние размеров целика\n\n' +
        
        '**10. ВЕЙНТЕСТ (КРЫЛЬЧАТЫЙ СДВИГ):**\n\n' +
        
        '**Применение:**\n' +
        '- Слабые глинистые грунты (IL > 0.75)\n' +
        '- Торфы\n' +
        '- Илы\n' +
        '- Экспресс-определение прочности\n\n' +
        
        '**Методика:**\n' +
        '- Крыльчатка (4 лопасти) в скважине\n' +
        '- Погружение на заданную глубину\n' +
        '- Вращение со скоростью 6°/мин\n' +
        '- Измерение крутящего момента M\n\n' +
        
        '**Расчёт недренированной прочности:**\n' +
        '```\n' +
        'cu = M / (π × D² × (H/2 + D/6))\n' +
        '\n' +
        'где:\n' +
        'D - диаметр крыльчатки (обычно 65 мм)\n' +
        'H - высота лопастей (обычно 130 мм)\n' +
        '```\n\n' +
        
        '**Преимущества вейнтеста:**\n' +
        '- Быстрота (5 мин на точку)\n' +
        '- Испытания на любой глубине\n' +
        '- Непрерывный профиль прочности\n' +
        '- Не требует отбора образцов\n\n' +
        
        '**Применение результатов:**\n' +
        '- Проектирование откосов и выемок\n' +
        '- Расчёт подпорных стен\n' +
        '- Оценка устойчивости склонов\n' +
        '- Несущая способность фундаментов (неглубоких)\n\n' +
        
        '**ВАЖНО:** Для ответственных откосов срезные испытания обязательны',
      
      recommendedValues: {
        testsPerIGE: {
          value: 3,
          unit: 'целиков',
          explanation: 'Целиков на ИГЭ (по 3-5 опытов каждый)'
        },
        vaneTests: {
          value: 5,
          unit: 'точек',
          explanation: 'Вейнтест для слабых глин'
        }
      }
    }
  ],
  
  calculateValues: (input: GeologicalInput) => {
    const ige = input.expectedIGE || 3;
    
    // Целики для стандартного срезного испытания
    const monoliths = ige * 2;
    
    // Вейнтест - только для слабых глин
    const hasWeakClays = input.soilTypes?.includes('глинистые') &&
                         input.geotechnicalCategory === 'III';
    const vaneTests = hasWeakClays ? 5 : 0;
    
    return {
      shearTestMonoliths: {
        value: monoliths,
        unit: 'целиков',
        explanation: 'Испытания срезом целиков',
        confidence: 85
      },
      vaneTests: {
        value: vaneTests,
        unit: 'точек',
        explanation: 'Крыльчатый сдвиг (вейнтест)',
        confidence: 80
      }
    };
  },
  
  generateWorks: (input: GeologicalInput) => {
    const works: WorkItem[] = [];
    const values = block_24_01_field_shear.calculateValues!(input);
    
    const qtyMonoliths = typeof values.shearTestMonoliths.value === 'number'
      ? values.shearTestMonoliths.value
      : parseInt(String(values.shearTestMonoliths.value));
    
    if (qtyMonoliths > 0) {
      works.push({
        workId: 'FIELD-SHEAR-01',
        name: 'Полевые испытания грунтов срезом (целики)',
        description: 
          'Выделение монолитов 0.4×0.4 м в шурфах. ' +
          'Испытания при 3-5 нормальных напряжениях σ. ' +
          'Определение φ и c',
        unit: 'целик',
        quantity: qtyMonoliths,
        category: 'recommended',
        module: 'geological',
        priority: 'РЕКОМЕНДУЕМЫЙ',
        normativeBase: 'ГОСТ 20276-2012',
        tags: ['полевые', 'срез', 'прочность'],
        priceTableCode: '1602-0410'
      });
    }
    
    const qtyVane = typeof values.vaneTests.value === 'number'
      ? values.vaneTests.value
      : parseInt(String(values.vaneTests.value));
    
    if (qtyVane > 0) {
      works.push({
        workId: 'FIELD-VANE-01',
        name: 'Испытания крыльчаткой (вейнтест)',
        description: 
          'Вращательный срез крыльчаткой в скважине. ' +
          'Определение недренированной прочности cu слабых глин',
        unit: 'точка',
        quantity: qtyVane,
        category: 'recommended',
        module: 'geological',
        priority: 'РЕКОМЕНДУЕМЫЙ',
        normativeBase: 'ГОСТ 20276-2012',
        tags: ['полевые', 'вейнтест', 'слабые-грунты'],
        priceTableCode: '1602-0411'
      });
    }
    
    return works;
  }
};

export const section24_blocks: InstructionBlock[] = [
  block_24_01_field_shear
];

export default section24_blocks;
