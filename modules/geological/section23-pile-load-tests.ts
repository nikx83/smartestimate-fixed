/**
 * Файл: section23-pile-load-tests.ts
 * Назначение: Статические испытания свай
 */

import type { 
  InstructionBlock, 
  GeologicalInput, 
  WorkItem 
} from './types';

/**
 * Блок 23.1: Испытания свай вдавливанием
 */
export const block_23_01_pile_compression: InstructionBlock = {
  id: 'block-23-01-pile-compression',
  section: 'Раздел 23: Испытания свай',
  title: 'Статические испытания свай вертикальной вдавливающей нагрузкой',
  description: 'Определение несущей способности свай по грунту',
  priority: 39,
  tags: ['полевые', 'сваи', 'испытания', 'несущая-способность'],
  
  condition: (input: GeologicalInput) => {
    return input.foundationType === 'свайный';
  },
  
  variants: [
    {
      id: 'variant-pile-compression',
      priority: 'ОБЯЗАТЕЛЬНЫЙ',
      normative: {
        document: 'ГОСТ 5686-2020',
        section: 'Испытания свай статической нагрузкой',
        priority: 'ОБЯЗАТЕЛЬНЫЙ'
      },
      recommendation:
        '**СТАТИЧЕСКИЕ ИСПЫТАНИЯ СВАЙ ВДАВЛИВАНИЕМ:**\n\n' +
        
        '**1. НАЗНАЧЕНИЕ:**\n' +
        '- Определение фактической несущей способности Fd\n' +
        '- Проверка проектных решений\n' +
        '- Оценка осадок свай под нагрузкой\n' +
        '- Контроль качества свайных работ\n' +
        '- Уточнение расчётных параметров грунтов\n\n' +
        
        '**2. ВИДЫ ИСПЫТАНИЙ:**\n\n' +
        
        '**А. Предварительные (до начала строительства):**\n' +
        '- На опытном полигоне\n' +
        '- Проверка проекта\n' +
        '- Корректировка длины и типа свай\n\n' +
        
        '**Б. Контрольные (в процессе строительства):**\n' +
        '- На рабочих сваях\n' +
        '- Контроль качества забивки/устройства\n' +
        '- Проверка соответствия грунтовых условий\n\n' +
        
        '**3. МЕТОДИКА ИСПЫТАНИЙ:**\n\n' +
        
        '**Подготовка:**\n' +
        '- Выдержка после устройства:\n' +
        '  * Забивные: 3-6 дней\n' +
        '  * Буронабивные: 15-28 дней (набор прочности бетона)\n' +
        '- Установка нагружающего устройства\n' +
        '- Установка приборов измерения осадок (4 прогибомера)\n\n' +
        
        '**Схема нагружения:**\n' +
        '```\n' +
        'Ступени нагрузки:\n' +
        'ΔP = (1.2 × Fd) / 10 - 12 ступеней\n' +
        '\n' +
        'Pmax = 2.0 × Fd (контрольные)\n' +
        'Pmax = 2.5 × Fd (предварительные)\n' +
        '```\n\n' +
        
        '**Выдержка под нагрузкой:**\n' +
        '- Критерий стабилизации осадки:\n' +
        '  Δs < 0.1 мм за последний час\n' +
        '- Минимальная выдержка: 1 час\n' +
        '- Для слабых грунтов: 2-3 часа\n\n' +
        
        '**Замеры осадок:**\n' +
        '- После нагружения: 5, 10, 15, 30, 45, 60 мин\n' +
        '- Далее каждые 30 минут\n' +
        '- Средняя осадка: s = (s₁ + s₂ + s₃ + s₄) / 4\n\n' +
        
        '**4. КРИТЕРИИ ПРЕДЕЛЬНОЙ НАГРУЗКИ:**\n\n' +
        
        '**Для висячих свай:**\n' +
        '```\n' +
        'Fu = Pкр\n' +
        '\n' +
        'где Pкр определяется по одному из условий:\n' +
        'а) s > 40 мм (абсолютная осадка)\n' +
        'б) Скорость нарастания осадки > 0.1 мм/час и не затухает\n' +
        'в) s/d > 0.20 (20% от диаметра)\n' +
        '```\n\n' +
        
        '**Для свай-стоек:**\n' +
        '```\n' +
        'Fu определяется по прочности материала сваи\n' +
        'или грунта основания\n' +
        '```\n\n' +
        
        '**5. ОПРЕДЕЛЕНИЕ НЕСУЩЕЙ СПОСОБНОСТИ:**\n\n' +
        
        '**Расчётная несущая способность:**\n' +
        '```\n' +
        'Fd = Fu / γk\n' +
        '\n' +
        'где:\n' +
        'Fu - предельная нагрузка по грунту\n' +
        'γk - коэффициент надёжности по грунту\n' +
        'γk = 1.4 (для предварительных испытаний, n ≥ 3)\n' +
        'γk = 1.2 (для контрольных испытаний, n ≥ 6)\n' +
        '```\n\n' +
        
        '**6. ОБРАБОТКА РЕЗУЛЬТАТОВ:**\n\n' +
        
        '**График P - s:**\n' +
        '- Зависимость нагрузки от осадки\n' +
        '- Выявление точки перелома (начало разрушения)\n' +
        '- Определение Pкр графически\n\n' +
        
        '**График s - lg(t):**\n' +
        '- Контроль стабилизации осадок\n' +
        '- Прямолинейный участок = стабилизация\n\n' +
        
        '**7. КОЛИЧЕСТВО ИСПЫТАНИЙ:**\n\n' +
        
        '**Предварительные:**\n' +
        '- Минимум: 3 сваи\n' +
        '- Рекомендуется: 5-7 свай\n' +
        '- По типам свай: каждый тип отдельно\n\n' +
        
        '**Контрольные:**\n' +
        '- 1% от общего числа свай, но не менее:\n' +
        '  * 2 сваи при N < 50\n' +
        '  * 3 сваи при 50 ≤ N < 100\n' +
        '  * 6 свай при N ≥ 100\n\n' +
        
        '**8. НАГРУЖАЮЩИЕ УСТРОЙСТВА:**\n\n' +
        
        '**А. Анкерные сваи:**\n' +
        '- 4-8 анкерных свай вокруг испытываемой\n' +
        '- Расстояние: ≥6d от испытываемой\n' +
        '- Балки + домкрат\n' +
        '- Преимущество: не требует пригруза\n\n' +
        
        '**Б. Платформа с пригрузом:**\n' +
        '- Платформа с балластом\n' +
        '- Масса: ≥1.3 × Pmax\n' +
        '- Преимущество: простота\n' +
        '- Недостаток: большая масса\n\n' +
        
        '**9. ТИПИЧНЫЕ РЕЗУЛЬТАТЫ:**\n\n' +
        
        '**Забивные сваи (железобетонные):**\n' +
        '- C1-30 (d=0.3м, L=8м): Fu = 600-1000 кН\n' +
        '- C1-30 (d=0.3м, L=12м): Fu = 900-1500 кН\n\n' +
        
        '**Буронабивные сваи:**\n' +
        '- d=0.6м, L=12м: Fu = 1500-2500 кН\n' +
        '- d=0.8м, L=15м: Fu = 2500-4000 кН\n\n' +
        
        '**Зависит от:**\n' +
        '- Длины заделки в несущий слой\n' +
        '- Свойств грунтов по стволу и под острием\n' +
        '- Технологии устройства\n\n' +
        
        '**10. СПЕЦИАЛЬНЫЕ ВИДЫ:**\n\n' +
        
        '**А. Испытания выдёргиванием:**\n' +
        '- Определение сопротивления боковой поверхности\n' +
        '- Для свай в просадочных грунтах\n\n' +
        
        '**Б. Испытания горизонтальной нагрузкой:**\n' +
        '- Для свай под опоры ЛЭП, мостов\n' +
        '- Определение горизонтальной несущей способности\n\n' +
        
        '**В. Динамические испытания:**\n' +
        '- Ударами молота с измерением отказа\n' +
        '- Экспресс-метод (менее надёжен)\n\n' +
        
        '**11. ПРОДОЛЖИТЕЛЬНОСТЬ:**\n' +
        '- Подготовка: 0.5 дня\n' +
        '- Испытание: 1-2 дня на сваю\n' +
        '- Всего: 3-5 дней на объект\n\n' +
        
        '**ВАЖНО:** Статические испытания - обязательны для всех свайных фундаментов',
      
      recommendedValues: {
        preliminaryTests: {
          value: 3,
          unit: 'свай',
          explanation: 'Предварительные испытания'
        },
        controlTestsPercent: {
          value: 1,
          unit: '%',
          explanation: 'От общего числа свай'
        }
      }
    }
  ],
  
  calculateValues: (input: GeologicalInput) => {
    // Предварительные испытания
    const preliminaryTests = 3;
    
    // Контрольные (если известно число свай)
    let controlTests = 2;
    if (input.numberOfPiles) {
      if (input.numberOfPiles < 50) {
        controlTests = 2;
      } else if (input.numberOfPiles < 100) {
        controlTests = 3;
      } else {
        controlTests = Math.max(6, Math.ceil(input.numberOfPiles * 0.01));
      }
    }
    
    return {
      preliminaryPileTests: {
        value: preliminaryTests,
        unit: 'свай',
        explanation: 'Предварительные испытания',
        confidence: 100
      },
      controlPileTests: {
        value: controlTests,
        unit: 'свай',
        explanation: 'Контрольные испытания',
        confidence: 85
      },
      totalPileTests: {
        value: preliminaryTests + controlTests,
        unit: 'свай',
        explanation: 'Всего статических испытаний свай',
        confidence: 90
      }
    };
  },
  
  generateWorks: (input: GeologicalInput) => {
    const works: WorkItem[] = [];
    const values = block_23_01_pile_compression.calculateValues!(input);
    
    const qtyPreliminary = typeof values.preliminaryPileTests.value === 'number'
      ? values.preliminaryPileTests.value
      : parseInt(String(values.preliminaryPileTests.value));
    
    const qtyControl = typeof values.controlPileTests.value === 'number'
      ? values.controlPileTests.value
      : parseInt(String(values.controlPileTests.value));
    
    works.push({
      workId: 'FIELD-PILE-01',
      name: 'Статические испытания свай вдавливающей нагрузкой (предварительные)',
      description: 
        'Испытания опытных свай до начала строительства. ' +
        'Определение предельной нагрузки Fu и несущей способности Fd. ' +
        'Ступенчатое нагружение до 2.5×Fd',
      unit: 'свая',
      quantity: qtyPreliminary,
      category: 'mandatory',
      module: 'geological',
      priority: 'ОБЯЗАТЕЛЬНЫЙ',
      normativeBase: 'ГОСТ 5686-2020',
      tags: ['полевые', 'сваи', 'несущая-способность'],
      priceTableCode: '1602-0408'
    });
    
    works.push({
      workId: 'FIELD-PILE-02',
      name: 'Статические испытания свай вдавливающей нагрузкой (контрольные)',
      description: 
        'Контрольные испытания рабочих свай в процессе строительства. ' +
        'Проверка качества свайных работ. Нагружение до 2.0×Fd',
      unit: 'свая',
      quantity: qtyControl,
      category: 'mandatory',
      module: 'geological',
      priority: 'ОБЯЗАТЕЛЬНЫЙ',
      normativeBase: 'ГОСТ 5686-2020',
      tags: ['полевые', 'сваи', 'контроль'],
      priceTableCode: '1602-0409'
    });
    
    return works;
  }
};

export const section23_blocks: InstructionBlock[] = [
  block_23_01_pile_compression
];

export default section23_blocks;
