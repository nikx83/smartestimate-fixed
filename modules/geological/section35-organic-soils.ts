/**
 * Файл: section35-organic-soils.ts
 * Назначение: Лабораторные испытания органических грунтов (торфов)
 */

import type { 
  InstructionBlock, 
  GeologicalInput, 
  WorkItem 
} from './types';

/**
 * Блок 35.1: Испытания органических грунтов
 */
export const block_35_01_organic_soils: InstructionBlock = {
  id: 'block-35-01-organic-soils',
  section: 'Раздел 35: Органические грунты',
  title: 'Лабораторные испытания торфов и заторфованных грунтов',
  description: 'Определение свойств органических грунтов',
  priority: 50,
  tags: ['лабораторные', 'торфы', 'органические', 'слабые-грунты'],
  
  condition: (input: GeologicalInput) => {
    return input.soilTypes?.includes('торфы') ||
           input.soilTypes?.includes('органические') ||
           input.soilTypes?.includes('заторфованные');
  },
  
  variants: [
    {
      id: 'variant-organic-standard',
      priority: 'ОБЯЗАТЕЛЬНЫЙ',
      normative: {
        document: 'ГОСТ 25100-2020',
        section: 'Грунты органические',
        priority: 'ОБЯЗАТЕЛЬНЫЙ'
      },
      recommendation:
        '**ЛАБОРАТОРНЫЕ ИСПЫТАНИЯ ОРГАНИЧЕСКИХ ГРУНТОВ:**\n\n' +
        
        '**1. КЛАССИФИКАЦИЯ ОРГАНИЧЕСКИХ ГРУНТОВ:**\n\n' +
        
        '**По содержанию органики (Iom):**\n' +
        '```\n' +
        'Iom = (Morg / Mсух) × 100%\n' +
        '\n' +
        'где Morg - масса органических веществ\n' +
        '```\n\n' +
        
        '**Группы:**\n' +
        '- Заторфованные: 0.25 < Iom ≤ 0.40 (25-40%)\n' +
        '- Торфы: Iom > 0.50 (>50%)\n' +
        '  * Слаборазложившиеся: степень разложения R < 20%\n' +
        '  * Среднеразложившиеся: 20% ≤ R < 40%\n' +
        '  * Сильноразложившиеся: R ≥ 40%\n\n' +
        
        '**По происхождению:**\n' +
        '- Верховые торфы (сфагновые)\n' +
        '- Низинные торфы (осоковые, тростниковые)\n' +
        '- Переходные торфы\n\n' +
        
        '**2. ОБЯЗАТЕЛЬНЫЕ ИСПЫТАНИЯ:**\n\n' +
        
        '**А. Влажность (W):**\n' +
        '- Высушивание при 105°C до постоянной массы\n' +
        '- Для торфов: обычно W = 200-1000% !\n' +
        '- Для заторфованных: W = 100-300%\n\n' +
        
        '**Б. Плотность (ρ):**\n' +
        '- Метод режущего кольца объёмом 100-200 см³\n' +
        '- Типичные значения:\n' +
        '  * Торфы: ρ = 0.90-1.15 г/см³\n' +
        '  * Заторфованные: ρ = 1.50-1.70 г/см³\n\n' +
        
        '**В. Плотность частиц (ρs):**\n' +
        '- Пикнометрический метод\n' +
        '- Для торфов: ρs = 1.50-1.65 г/см³\n' +
        '- Ниже, чем у минеральных грунтов (2.65-2.70)\n\n' +
        
        '**Г. Зольность (A):**\n' +
        '- Сжигание при 800°C\n' +
        '```\n' +
        'A = (Mзолы / Mсух) × 100%\n' +
        '\n' +
        'Торфы: A < 50%\n' +
        'Заторфованные: A = 50-75%\n' +
        '```\n\n' +
        
        '**Д. Степень разложения (R):**\n' +
        '- Ботанико-морфологический анализ\n' +
        '- Определение под микроскопом\n' +
        '- Процент бесструктурного вещества\n\n' +
        
        '**3. МЕХАНИЧЕСКИЕ ХАРАКТЕРИСТИКИ:**\n\n' +
        
        '**А. Компрессионные испытания:**\n' +
        '- Одометр, образец h = 30-40 мм\n' +
        '- Нагрузки: 0.025, 0.05, 0.1, 0.2, 0.3 МПа\n' +
        '- Определение:\n' +
        '  * Коэффициента сжимаемости mv\n' +
        '  * Модуля деформации E₀\n' +
        '  * Коэффициента фильтрации K\n\n' +
        
        '**Типичные значения:**\n' +
        '```\n' +
        'E₀ = 0.3-2.0 МПа (очень сжимаемые!)\n' +
        'mv = 0.5-5.0 МПа⁻¹\n' +
        '```\n\n' +
        
        '**Б. Прочностные характеристики:**\n' +
        '- Трёхосное сжатие (стабилометр)\n' +
        '- Недренированный срез\n' +
        '- Определение:\n' +
        '  * φ (угол внутреннего трения)\n' +
        '  * cu (недренированное сцепление)\n\n' +
        
        '**Типичные значения:**\n' +
        '```\n' +
        'φ = 5-15° (очень низкое)\n' +
        'cu = 5-20 кПа\n' +
        '```\n\n' +
        
        '**4. СПЕЦИАЛЬНЫЕ ИСПЫТАНИЯ:**\n\n' +
        
        '**А. Ботанический состав:**\n' +
        '- Анализ растительных остатков\n' +
        '- Определение вида торфа\n' +
        '- Важно для оценки свойств\n\n' +
        
        '**Б. pH среды:**\n' +
        '- Верховые торфы: pH = 3.5-5.0 (кислые)\n' +
        '- Низинные торфы: pH = 5.5-7.0 (нейтральные)\n' +
        '- Влияет на коррозионность\n\n' +
        
        '**В. Коэффициент фильтрации (K):**\n' +
        '- Из компрессионных испытаний\n' +
        '- Или в одометре с перфорированными штампами\n' +
        '- Типично: K = 0.01-1.0 м/сут\n\n' +
        
        '**Г. Ползучесть:**\n' +
        '- Длительные испытания под нагрузкой\n' +
        '- Реологические свойства\n' +
        '- Важно для прогноза осадок во времени\n\n' +
        
        '**5. КОЛИЧЕСТВО ОБРАЗЦОВ:**\n' +
        '- Влажность, плотность: 5-10 определений\n' +
        '- Зольность: 3-5 определений\n' +
        '- Степень разложения: 2-3 определения\n' +
        '- Компрессия: 3-5 образцов на ИГЭ\n' +
        '- Прочность: 3-5 образцов\n\n' +
        
        '**6. ОСОБЕННОСТИ ОТБОРА ПРОБ:**\n' +
        '- Монолиты в обсадных трубах\n' +
        '- Грунтоносы с керном\n' +
        '- Сохранение природной влажности (герметизация)\n' +
        '- Быстрая доставка в лабораторию (<24 часа)\n' +
        '- Хранение при 4-8°C\n\n' +
        
        '**7. ТИПИЧНЫЕ ХАРАКТЕРИСТИКИ:**\n\n' +
        
        '**Торфы слаборазложившиеся (R<20%):**\n' +
        '- W = 700-1200%\n' +
        '- ρ = 0.95-1.05 г/см³\n' +
        '- E₀ = 0.3-0.8 МПа\n' +
        '- φ = 8-12°, cu = 8-15 кПа\n\n' +
        
        '**Торфы среднеразложившиеся (20%≤R<40%):**\n' +
        '- W = 400-800%\n' +
        '- ρ = 1.00-1.10 г/см³\n' +
        '- E₀ = 0.5-1.2 МПа\n' +
        '- φ = 10-15°, cu = 10-18 кПа\n\n' +
        
        '**Торфы сильноразложившиеся (R≥40%):**\n' +
        '- W = 300-600%\n' +
        '- ρ = 1.05-1.15 г/см³\n' +
        '- E₀ = 0.8-2.0 МПа\n' +
        '- φ = 12-18°, cu = 15-25 кПа\n\n' +
        
        '**Заторфованные грунты:**\n' +
        '- W = 100-300%\n' +
        '- ρ = 1.50-1.70 г/см³\n' +
        '- E₀ = 2-5 МПа\n' +
        '- φ = 15-20°, c = 15-30 кПа\n\n' +
        
        '**8. СТРОИТЕЛЬНЫЕ СВОЙСТВА:**\n' +
        '- Очень высокая сжимаемость (осадки до 1-3 м!)\n' +
        '- Низкая несущая способность (50-100 кПа)\n' +
        '- Длительная консолидация (годы)\n' +
        '- Вторичная осадка (ползучесть)\n' +
        '- Агрессивность к металлам (кислая среда)\n\n' +
        
        '**9. МЕТОДЫ УЛУЧШЕНИЯ:**\n' +
        '- Предварительное обжатие (пригруз)\n' +
        '- Замена торфа минеральным грунтом\n' +
        '- Свайные фундаменты (проходящие торф)\n' +
        '- Вертикальные дрены (ускорение консолидации)\n' +
        '- Глубинное уплотнение\n\n' +
        
        '**10. ПРИМЕНЕНИЕ РЕЗУЛЬТАТОВ:**\n' +
        '- Оценка возможности строительства\n' +
        '- Прогноз осадок (больших и длительных)\n' +
        '- Выбор типа фундамента\n' +
        '- Проектирование насыпей на торфах\n' +
        '- Оценка устойчивости откосов\n\n' +
        
        '**ВАЖНО:** Торфы - крайне сложные основания, требующие особых решений',
      
      recommendedValues: {
        samplesPerIGE: {
          value: 5,
          unit: 'образцов',
          explanation: 'На компрессию и прочность'
        },
        moistureTests: {
          value: 10,
          unit: 'определений',
          explanation: 'Влажность (высокая изменчивость)'
        }
      }
    }
  ],
  
  calculateValues: (input: GeologicalInput) => {
    const ige = input.expectedIGE || 2;
    
    // Количество испытаний
    const moisture = ige * 8;       // W (высокая изменчивость)
    const density = ige * 5;        // ρ
    const ashContent = ige * 3;     // Зольность
    const compression = ige * 4;    // Компрессия
    const strength = ige * 3;       // Прочность
    
    const total = moisture + density + ashContent + compression + strength;
    
    return {
      organicMoisture: {
        value: moisture,
        unit: 'определений',
        explanation: 'Влажность (W)',
        confidence: 90
      },
      organicDensity: {
        value: density,
        unit: 'определений',
        explanation: 'Плотность',
        confidence: 90
      },
      ashContent: {
        value: ashContent,
        unit: 'определений',
        explanation: 'Зольность (A)',
        confidence: 85
      },
      organicCompression: {
        value: compression,
        unit: 'образцов',
        explanation: 'Компрессионные испытания',
        confidence: 90
      },
      organicStrength: {
        value: strength,
        unit: 'образцов',
        explanation: 'Прочностные характеристики',
        confidence: 85
      },
      totalOrganicTests: {
        value: total,
        unit: 'испытаний',
        explanation: 'Всего испытаний органических грунтов',
        confidence: 90
      }
    };
  },
  
  generateWorks: (input: GeologicalInput) => {
    const works: WorkItem[] = [];
    const values = block_35_01_organic_soils.calculateValues!(input);
    
    const qtyMoisture = typeof values.organicMoisture.value === 'number'
      ? values.organicMoisture.value
      : parseInt(String(values.organicMoisture.value));
    
    const qtyDensity = typeof values.organicDensity.value === 'number'
      ? values.organicDensity.value
      : parseInt(String(values.organicDensity.value));
    
    const qtyAsh = typeof values.ashContent.value === 'number'
      ? values.ashContent.value
      : parseInt(String(values.ashContent.value));
    
    const qtyCompression = typeof values.organicCompression.value === 'number'
      ? values.organicCompression.value
      : parseInt(String(values.organicCompression.value));
    
    works.push({
      workId: 'LAB-ORG-01',
      name: 'Влажность органических грунтов',
      description: 
        'Высушивание при 105°C до постоянной массы. ' +
        'Для торфов W может достигать 1000%',
      unit: 'определение',
      quantity: qtyMoisture,
      category: 'mandatory',
      module: 'geological',
      priority: 'ОБЯЗАТЕЛЬНЫЙ',
      normativeBase: 'ГОСТ 5180-2015',
      tags: ['лабораторные', 'влажность', 'торфы'],
      priceTableCode: '1602-0717'
    });
    
    works.push({
      workId: 'LAB-ORG-02',
      name: 'Плотность органических грунтов',
      description: 
        'Определение плотности методом режущего кольца',
      unit: 'определение',
      quantity: qtyDensity,
      category: 'mandatory',
      module: 'geological',
      priority: 'ОБЯЗАТЕЛЬНЫЙ',
      normativeBase: 'ГОСТ 5180-2015',
      tags: ['лабораторные', 'плотность'],
      priceTableCode: '1602-0718'
    });
    
    works.push({
      workId: 'LAB-ORG-03',
      name: 'Зольность органических грунтов',
      description: 
        'Определение зольности сжиганием при 800°C',
      unit: 'определение',
      quantity: qtyAsh,
      category: 'mandatory',
      module: 'geological',
      priority: 'ОБЯЗАТЕЛЬНЫЙ',
      normativeBase: 'ГОСТ 25100-2020',
      tags: ['лабораторные', 'зольность'],
      priceTableCode: '1602-0719'
    });
    
    works.push({
      workId: 'LAB-ORG-04',
      name: 'Компрессионные испытания торфов',
      description: 
        'Одометр, определение E₀, mv, K. Нагрузки 0.025-0.3 МПа',
      unit: 'образец',
      quantity: qtyCompression,
      category: 'mandatory',
      module: 'geological',
      priority: 'ОБЯЗАТЕЛЬНЫЙ',
      normativeBase: 'ГОСТ 12248-2010',
      tags: ['лабораторные', 'компрессия', 'торфы'],
      priceTableCode: '1602-0720'
    });
    
    return works;
  }
};

export const section35_blocks: InstructionBlock[] = [
  block_35_01_organic_soils
];

export default section35_blocks;
