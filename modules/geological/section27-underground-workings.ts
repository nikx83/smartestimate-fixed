/**
 * Файл: section27-underground-workings.ts
 * Назначение: Проходка подземных горных выработок
 */

import type { 
  InstructionBlock, 
  GeologicalInput, 
  WorkItem 
} from './types';

/**
 * Блок 27.1: Горизонтальные выработки (штольни, шурфы)
 */
export const block_27_01_horizontal_workings: InstructionBlock = {
  id: 'block-27-01-horizontal-workings',
  section: 'Раздел 27: Подземные выработки',
  title: 'Проходка горизонтальных подземных выработок',
  description: 'Штольни, штреки, квершлаги для изучения массива',
  priority: 44,
  tags: ['горные-работы', 'подземные', 'штольни'],
  
  condition: (input: GeologicalInput) => {
    return input.requiresUndergroundWorkings === true ||
           input.hasMiningConditions === true ||
           (input.soilTypes?.includes('скальные') && input.geotechnicalCategory === 'III');
  },
  
  variants: [
    {
      id: 'variant-horizontal',
      priority: 'СПЕЦИАЛЬНЫЙ',
      normative: {
        document: 'СП РК 1.02-102-2014',
        section: 'Подземные горные выработки',
        priority: 'СПЕЦИАЛЬНЫЙ'
      },
      recommendation:
        '**ГОРИЗОНТАЛЬНЫЕ ПОДЗЕМНЫЕ ВЫРАБОТКИ:**\n\n' +
        
        '**1. ТИПЫ ВЫРАБОТОК:**\n\n' +
        
        '**А. Штольня:**\n' +
        '- Горизонтальная выработка с выходом на поверхность\n' +
        '- Проходится в склон\n' +
        '- Сечение: 2.0×2.0 м до 3.0×3.0 м\n' +
        '- Длина: 20-100 м\n' +
        '- Назначение: вскрытие массива, дренаж, геологическое изучение\n\n' +
        
        '**Б. Штрек:**\n' +
        '- Горизонтальная выработка без выхода\n' +
        '- Из шахты или штольни\n' +
        '- Сечение: 1.5×2.0 м\n' +
        '- Длина: 10-50 м\n\n' +
        
        '**В. Квершлаг:**\n' +
        '- Горизонтальная выработка поперёк простирания пород\n' +
        '- Для пересечения структурных элементов\n' +
        '- Сечение: 2.0×2.0 м\n\n' +
        
        '**Г. Ходок:**\n' +
        '- Разведочная горизонтальная выработка малого сечения\n' +
        '- Сечение: 1.2×1.5 м\n' +
        '- Длина: 5-20 м\n\n' +
        
        '**2. НАЗНАЧЕНИЕ:**\n' +
        '- Изучение массива скальных грунтов\n' +
        '- Оценка трещиноватости, выветривания\n' +
        '- Определение прочностных свойств в массиве\n' +
        '- Отбор керна из стенок\n' +
        '- Полевые испытания (штамповые, срезные)\n' +
        '- Гидрогеологические наблюдения (дренаж)\n' +
        '- Геофизические исследования (каротаж выработки)\n\n' +
        
        '**3. МЕТОДЫ ПРОХОДКИ:**\n\n' +
        
        '**А. Буровзрывной (скальные грунты):**\n' +
        '- Бурение шпуров (глубина 1.5-2.5 м)\n' +
        '- Заряжание ВВ\n' +
        '- Взрыв\n' +
        '- Проветривание (30-60 мин)\n' +
        '- Уборка породы\n' +
        '- Крепление\n' +
        '- Цикл: 1.5-2.5 м/сутки\n\n' +
        
        '**Б. Механизированный:**\n' +
        '- Проходческий комбайн\n' +
        '- Отбойный молоток\n' +
        '- В мягких скальных породах\n' +
        '- Производительность: 3-5 м/сутки\n\n' +
        
        '**В. Ручной:**\n' +
        '- В мягких/рыхлых породах\n' +
        '- Кирка, лом, лопата\n' +
        '- Производительность: 0.5-1.5 м/сутки\n\n' +
        
        '**4. КРЕПЛЕНИЕ:**\n\n' +
        
        '**Виды крепи:**\n' +
        '- Деревянная рамная: стойки + верхняк + затяжка\n' +
        '- Металлическая арочная: спецпрофиль СВП\n' +
        '- Анкерная: болты Ø20-25 мм, L=1.5-3.0 м\n' +
        '- Бетонная/набрызг-бетон: в устойчивых породах\n\n' +
        
        '**Шаг крепи:**\n' +
        '- Неустойчивые породы: 0.5-0.8 м\n' +
        '- Средней устойчивости: 1.0-1.5 м\n' +
        '- Устойчивые: 2.0-3.0 м или анкера\n\n' +
        
        '**5. ВЕНТИЛЯЦИЯ:**\n' +
        '- Нагнетательная: вентилятор + воздуховод\n' +
        '- Производительность: 100-300 м³/час\n' +
        '- Обязательна при длине >15 м\n' +
        '- Контроль газов (CO, CH₄)\n\n' +
        
        '**6. ОСВЕЩЕНИЕ:**\n' +
        '- Напряжение: 12-36 В (безопасное)\n' +
        '- Лампы через 5-10 м\n' +
        '- Аккумуляторные светильники у рабочих\n\n' +
        
        '**7. ВОДООТЛИВ:**\n' +
        '- Дренажная канавка по почве (20×20 см)\n' +
        '- Уклон 0.003-0.005 к устью\n' +
        '- Водосборник у устья\n' +
        '- Насосная станция при притоках >1 м³/час\n\n' +
        
        '**8. ДОКУМЕНТАЦИЯ:**\n' +
        '- Маркшейдерская съёмка (план, профиль)\n' +
        '- Геологическая документация стенок и кровли\n' +
        '- Замер трещиноватости (через 2-5 м)\n' +
        '- Отбор образцов керна из стенок\n' +
        '- Фотофиксация\n' +
        '- Журнал проходки\n\n' +
        
        '**9. ПРОИЗВОДИТЕЛЬНОСТЬ:**\n' +
        '```\n' +
        'Буровзрывная в граните: 1.5-2.0 м/сутки\n' +
        'Механизированная в известняке: 3-4 м/сутки\n' +
        'Ручная в глине: 0.5-1.0 м/сутки\n' +
        '```\n\n' +
        
        '**10. СТОИМОСТЬ:**\n' +
        '- Очень высокая: 50000-200000 тенге/п.м\n' +
        '- Зависит от крепости пород, крепления, длины\n\n' +
        
        '**11. ПРИМЕНЕНИЕ:**\n' +
        '- Гидротехнические сооружения (плотины, ГЭС)\n' +
        '- Тоннели автомобильные и железнодорожные\n' +
        '- Подземные сооружения (метро, хранилища)\n' +
        '- Карьеры и горные разработки\n' +
        '- Оценка устойчивости склонов\n\n' +
        
        '**12. ТЕХНИКА БЕЗОПАСНОСТИ:**\n\n' +
        
        '**КРИТИЧНО:**\n' +
        '- Крепление обязательно\n' +
        '- Проверка кровли перед началом работ\n' +
        '- Вентиляция обязательна\n' +
        '- Контроль газов\n' +
        '- Запасной выход при длине >50 м\n' +
        '- Связь с поверхностью\n' +
        '- Спасательное оборудование\n' +
        '- Медицинский пост на поверхности\n\n' +
        
        '**ВАЖНО:** Проходка подземных выработок - опасная работа, требует специальной квалификации',
      
      recommendedValues: {
        crossSection: {
          value: 4,
          unit: 'м²',
          explanation: 'Типичное сечение (2×2 м)'
        },
        rate: {
          value: 2,
          unit: 'м/сутки',
          explanation: 'Производительность буровзрывной'
        }
      }
    }
  ],
  
  calculateValues: (input: GeologicalInput) => {
    // Подземные выработки - только для специальных объектов
    if (!input.requiresUndergroundWorkings) {
      return {
        undergroundLength: {
          value: 0,
          unit: 'п.м',
          explanation: 'Не требуется',
          confidence: 100
        }
      };
    }
    
    // Типичная длина штольни
    const length = 30;
    const crossSection = 4; // м²
    const volume = length * crossSection;
    
    return {
      undergroundLength: {
        value: length,
        unit: 'п.м',
        explanation: 'Длина подземной выработки',
        confidence: 80
      },
      volume: {
        value: volume,
        unit: 'м³',
        explanation: 'Объём выемки',
        confidence: 80
      }
    };
  },
  
  generateWorks: (input: GeologicalInput) => {
    const works: WorkItem[] = [];
    const values = block_27_01_horizontal_workings.calculateValues!(input);
    
    if (values.undergroundLength.value === 0) {
      return works;
    }
    
    const length = typeof values.undergroundLength.value === 'number'
      ? values.undergroundLength.value
      : parseFloat(String(values.undergroundLength.value));
    
    works.push({
      workId: 'MINING-TUNNEL-01',
      name: 'Проходка горизонтальных подземных выработок',
      description: 
        'Проходка штольни/штрека сечением 2×2 м. Буровзрывные работы, ' +
        'крепление, вентиляция, водоотлив, документация',
      unit: 'п.м',
      quantity: length,
      category: 'special',
      module: 'geological',
      priority: 'СПЕЦИАЛЬНЫЙ',
      normativeBase: 'СП РК 1.02-102-2014',
      tags: ['горные-работы', 'подземные', 'штольни'],
      priceTableCode: '1602-0302-02'
    });
    
    return works;
  }
};

/**
 * Блок 27.2: Вертикальные выработки (шахты)
 */
export const block_27_02_vertical_workings: InstructionBlock = {
  id: 'block-27-02-vertical-shafts',
  section: 'Раздел 27: Подземные выработки',
  title: 'Проходка вертикальных шахт',
  description: 'Глубокие вертикальные выработки для изучения массива',
  priority: 45,
  tags: ['горные-работы', 'шахты', 'вертикальные'],
  
  condition: (input: GeologicalInput) => {
    return input.requiresDeepShafts === true ||
           (input.foundationDepth !== undefined && input.foundationDepth > 10);
  },
  
  variants: [
    {
      id: 'variant-shafts',
      priority: 'СПЕЦИАЛЬНЫЙ',
      normative: {
        document: 'СП РК 1.02-102-2014',
        section: 'Вертикальные выработки',
        priority: 'СПЕЦИАЛЬНЫЙ'
      },
      recommendation:
        '**ПРОХОДКА ВЕРТИКАЛЬНЫХ ШАХТ:**\n\n' +
        
        '**1. НАЗНАЧЕНИЕ:**\n' +
        '- Изучение грунтов на большую глубину (>10 м)\n' +
        '- Вскрытие глубоких водоносных горизонтов\n' +
        '- Доступ для горизонтальных выработок\n' +
        '- Отбор образцов с глубины\n' +
        '- Полевые испытания на разных глубинах\n\n' +
        
        '**2. РАЗМЕРЫ:**\n' +
        '- Сечение: 2.0×2.0 м до 3.0×3.0 м\n' +
        '- Глубина: 10-50 м (иногда до 100 м)\n' +
        '- Форма: круглая или прямоугольная\n\n' +
        
        '**3. МЕТОДЫ ПРОХОДКИ:**\n' +
        '- Буровзрывной (в скальных)\n' +
        '- Механизированный (грейфер, бадья)\n' +
        '- Ручной с креплением (в рыхлых)\n\n' +
        
        '**4. КРЕПЛЕНИЕ:**\n' +
        '- Сплошное по всей глубине\n' +
        '- Деревянное: венцы из брёвен\n' +
        '- Бетонное: кольца или монолит\n' +
        '- Металлическое: тюбинги\n\n' +
        
        '**5. ОБОРУДОВАНИЕ:**\n' +
        '- Лебёдка для подъёма/спуска\n' +
        '- Бадья (ёмкость для породы)\n' +
        '- Вентилятор с воздуховодом\n' +
        '- Насос для водоотлива\n' +
        '- Лестница для спуска людей\n\n' +
        
        '**6. ПРОИЗВОДИТЕЛЬНОСТЬ:**\n' +
        '- 2-4 м/сутки (в зависимости от грунта)\n' +
        '- Срок проходки шахты 20 м: 10-15 дней\n\n' +
        
        '**7. СТОИМОСТЬ:**\n' +
        '- Крайне высокая: 100000-500000 тенге/п.м\n\n' +
        
        '**ВАЖНО:** Шахты - самые дорогие и опасные выработки',
      
      recommendedValues: {
        depth: {
          value: 20,
          unit: 'м',
          explanation: 'Типичная глубина'
        }
      }
    }
  ],
  
  calculateValues: (input: GeologicalInput) => {
    if (!input.requiresDeepShafts) {
      return {
        shaftDepth: {
          value: 0,
          unit: 'п.м',
          explanation: 'Не требуется',
          confidence: 100
        }
      };
    }
    
    const depth = 20; // типичная глубина
    const crossSection = 4; // 2×2 м
    const volume = depth * crossSection;
    
    return {
      shaftDepth: {
        value: depth,
        unit: 'п.м',
        explanation: 'Глубина шахты',
        confidence: 75
      },
      volume: {
        value: volume,
        unit: 'м³',
        explanation: 'Объём выемки',
        confidence: 75
      }
    };
  },
  
  generateWorks: (input: GeologicalInput) => {
    const works: WorkItem[] = [];
    const values = block_27_02_vertical_workings.calculateValues!(input);
    
    if (values.shaftDepth.value === 0) {
      return works;
    }
    
    const depth = typeof values.shaftDepth.value === 'number'
      ? values.shaftDepth.value
      : parseFloat(String(values.shaftDepth.value));
    
    works.push({
      workId: 'MINING-SHAFT-DEEP-01',
      name: 'Проходка вертикальных шахт',
      description: 
        'Проходка глубокой шахты 2×2 м. Крепление, подъём породы, ' +
        'вентиляция, водоотлив, лестница',
      unit: 'п.м',
      quantity: depth,
      category: 'special',
      module: 'geological',
      priority: 'СПЕЦИАЛЬНЫЙ',
      normativeBase: 'СП РК 1.02-102-2014',
      tags: ['горные-работы', 'шахты', 'глубокие'],
      priceTableCode: '1602-0302-01'
    });
    
    return works;
  }
};

export const section27_blocks: InstructionBlock[] = [
  block_27_01_horizontal_workings,
  block_27_02_vertical_workings
];

export default section27_blocks;
