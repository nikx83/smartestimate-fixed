/**
 * Файл: section20-plate-load-tests.ts
 * Назначение: Штамповые испытания грунтов
 */

import type { 
  InstructionBlock, 
  GeologicalInput, 
  WorkItem 
} from './types';

/**
 * Блок 20.1: Штамповые испытания
 */
export const block_20_01_plate_tests: InstructionBlock = {
  id: 'block-20-01-plate-load-tests',
  section: 'Раздел 20: Штамповые испытания',
  title: 'Испытания грунтов статической нагрузкой (штампами)',
  description: 'Определение модуля деформации и несущей способности in situ',
  priority: 36,
  tags: ['полевые', 'штампы', 'модуль-деформации'],
  
  condition: (input: GeologicalInput) => {
    return input.geotechnicalCategory === 'III' ||
           input.numberOfFloors >= 10 ||
           input.foundationType === 'плитный';
  },
  
  variants: [
    {
      id: 'variant-plate-standard',
      priority: 'ОБЯЗАТЕЛЬНЫЙ',
      normative: {
        document: 'ГОСТ 20276-2012',
        section: 'Методы полевых испытаний грунтов',
        priority: 'ОБЯЗАТЕЛЬНЫЙ'
      },
      recommendation:
        '**ШТАМПОВЫЕ ИСПЫТАНИЯ:**\n\n' +
        
        '**1. НАЗНАЧЕНИЕ:**\n' +
        '- Определение модуля деформации E непосредственно в массиве\n' +
        '- Оценка несущей способности грунтов\n' +
        '- Проверка расчётных параметров\n' +
        '- Контроль уплотнения насыпей\n' +
        '- Испытания слабых и специфических грунтов\n\n' +
        
        '**2. ОБОРУДОВАНИЕ:**\n\n' +
        
        '**А. Жёсткий штамп:**\n' +
        '- Площадь: 600, 3000, 5000 см²\n' +
        '- Стандарт: F = 5000 см² (круг Ø 80 см)\n' +
        '- Материал: стальная плита толщиной 25-30 мм\n' +
        '- Рёбра жёсткости снизу\n\n' +
        
        '**Б. Нагружающее устройство:**\n' +
        '- Домкрат гидравлический\n' +
        '- Упор: анкера, сваи, тяжёлый груз\n' +
        '- Максимальная нагрузка: 500-1000 кН\n\n' +
        
        '**В. Измерительные приборы:**\n' +
        '- Прогибомеры (3-4 шт) с точностью 0.01 мм\n' +
        '- Манометр для контроля давления\n' +
        '- Часы или секундомер\n\n' +
        
        '**3. ПОДГОТОВКА ПЛОЩАДКИ:**\n' +
        '- Шурф глубиной 1.5-3.0 м\n' +
        '- Или дно скважины (при испытаниях на глубине)\n' +
        '- Зачистка поверхности грунта\n' +
        '- Выравнивание песком (слой 2-3 см)\n' +
        '- Установка штампа строго горизонтально\n\n' +
        
        '**4. МЕТОДИКА ИСПЫТАНИЙ:**\n\n' +
        
        '**А. Схема нагружения:**\n' +
        '- Ступени: 0.05, 0.1, 0.15, 0.2, 0.25, 0.3, 0.35 МПа\n' +
        '- Шаг нагрузки: ΔP = 0.05 МПа (или 0.1 МПа для плотных)\n' +
        '- Максимальное давление: 0.3-0.5 МПа\n' +
        '- Или до достижения предельной нагрузки\n\n' +
        
        '**Б. Выдержка под нагрузкой:**\n' +
        '- Критерий стабилизации осадки:\n' +
        '  Δs < 0.1 мм за последние 60 минут\n' +
        '- Минимальная выдержка: 1 час\n' +
        '- Для глинистых грунтов: 2-3 часа\n\n' +
        
        '**В. Замеры осадок:**\n' +
        '- После приложения нагрузки: 5, 10, 15, 30, 45, 60 мин, далее каждые 30 мин\n' +
        '- Средняя осадка: s = (s₁ + s₂ + s₃) / 3\n\n' +
        
        '**5. ОБРАБОТКА РЕЗУЛЬТАТОВ:**\n\n' +
        
        '**А. График P - s:**\n' +
        '- По оси X: осадка s (мм)\n' +
        '- По оси Y: давление P (МПа)\n' +
        '- Выделить прямолинейный участок\n\n' +
        
        '**Б. Модуль деформации:**\n' +
        '```\n' +
        'E = (1 - ν²) × ω × d × (ΔP / Δs)\n' +
        '\n' +
        'где:\n' +
        'ν - коэффициент Пуассона (0.25-0.40)\n' +
        'ω - коэффициент формы штампа (0.8 для круга)\n' +
        'd - диаметр штампа, м\n' +
        'ΔP - приращение давления, МПа\n' +
        'Δs - приращение осадки, м\n' +
        '```\n\n' +
        
        '**Упрощённо (для круглого штампа Ø 80 см, ν = 0.3):**\n' +
        '```\n' +
        'E = 0.8 × (ΔP / Δs)    [МПа]\n' +
        '```\n\n' +
        
        '**В. Несущая способность:**\n' +
        '- Предельная нагрузка Pu - когда s > 40 мм\n' +
        '- Или s/d > 0.05 (5% от диаметра)\n' +
        '- Или прогрессирующие осадки\n\n' +
        
        '**6. ТИПИЧНЫЕ ЗНАЧЕНИЯ E:**\n\n' +
        
        '**Песчаные грунты:**\n' +
        '- Пески рыхлые: E = 10-15 МПа\n' +
        '- Пески средней плотности: E = 15-25 МПа\n' +
        '- Пески плотные: E = 25-40 МПа\n\n' +
        
        '**Глинистые грунты:**\n' +
        '- Супеси пластичные: E = 8-15 МПа\n' +
        '- Суглинки мягкопластичные: E = 10-20 МПа\n' +
        '- Суглинки тугопластичные: E = 20-30 МПа\n' +
        '- Глины полутвёрдые: E = 25-40 МПа\n\n' +
        
        '**7. КОЛИЧЕСТВО ИСПЫТАНИЙ:**\n\n' +
        
        '**По категории объекта:**\n' +
        '- I категория: 2 испытания на объект\n' +
        '- II категория: 3-4 испытания\n' +
        '- III категория: 5-6 испытаний\n\n' +
        
        '**По количеству ИГЭ:**\n' +
        '- Минимум 2 испытания на каждый ИГЭ\n' +
        '- Для ответственных объектов: 3 испытания на ИГЭ\n\n' +
        
        '**8. ГЛУБИНА ИСПЫТАНИЙ:**\n' +
        '- На поверхности (в шурфах)\n' +
        '- На проектной отметке фундамента\n' +
        '- На разных глубинах в пределах сжимаемой толщи\n' +
        '- Для свайных фундаментов: на уровне острия свай\n\n' +
        
        '**9. ПРЕИМУЩЕСТВА МЕТОДА:**\n' +
        '- Испытания ненарушенного массива\n' +
        '- Учёт природной структуры\n' +
        '- Прямое определение E (без корреляций)\n' +
        '- Оценка несущей способности\n' +
        '- Контроль качества уплотнения\n\n' +
        
        '**10. НЕДОСТАТКИ:**\n' +
        '- Трудоёмкость (1-2 испытания в день)\n' +
        '- Высокая стоимость\n' +
        '- Сложность на большой глубине\n' +
        '- Малая зона влияния (~1.5d)\n\n' +
        
        '**11. СПЕЦИАЛЬНЫЕ ВИДЫ:**\n\n' +
        
        '**А. Штамп с замачиванием:**\n' +
        '- Для просадочных грунтов\n' +
        '- Определение εsl и E после замачивания\n\n' +
        
        '**Б. Винтовой штамп:**\n' +
        '- Для испытаний на глубине без шурфа\n' +
        '- Раскрываемые лопасти\n\n' +
        
        '**В. Динамический штамп:**\n' +
        '- Вдавливание ударами\n' +
        '- Для грунтов с включениями\n\n' +
        
        '**ВАЖНО:** Штамповые испытания - эталонный метод определения E',
      
      recommendedValues: {
        testsPerIGE: {
          value: 2,
          unit: 'испытаний',
          explanation: 'Минимум на каждый ИГЭ'
        },
        stampArea: {
          value: 5000,
          unit: 'см²',
          explanation: 'Стандартная площадь штампа'
        },
        duration: {
          value: 8,
          unit: 'часов',
          explanation: 'Продолжительность одного испытания'
        }
      }
    }
  ],
  
  calculateValues: (input: GeologicalInput) => {
    const ige = input.expectedIGE || 3;
    const testsPerIGE = 2;
    
    // Для III категории или высоких зданий - больше испытаний
    const multiplier = (input.geotechnicalCategory === 'III' || 
                        (input.numberOfFloors && input.numberOfFloors >= 10)) ? 1.5 : 1.0;
    
    const totalTests = Math.ceil(ige * testsPerIGE * multiplier);
    
    return {
      plateTests: {
        value: totalTests,
        unit: 'испытаний',
        explanation: 'Штамповые испытания',
        confidence: 90
      },
      estimatedDays: {
        value: Math.ceil(totalTests / 1.5),
        unit: 'дней',
        explanation: 'Продолжительность работ (1-2 испытания/день)',
        confidence: 85
      }
    };
  },
  
  generateWorks: (input: GeologicalInput) => {
    const works: WorkItem[] = [];
    const values = block_20_01_plate_tests.calculateValues!(input);
    
    const qty = typeof values.plateTests.value === 'number'
      ? values.plateTests.value
      : parseInt(String(values.plateTests.value));
    
    works.push({
      workId: 'FIELD-PLATE-01',
      name: 'Штамповые испытания грунтов',
      description: 
        'Испытания статической нагрузкой жёстким штампом F=5000 см². ' +
        'Определение модуля деформации E и несущей способности',
      unit: 'испытание',
      quantity: qty,
      category: 'mandatory',
      module: 'geological',
      priority: 'ОБЯЗАТЕЛЬНЫЙ',
      normativeBase: 'ГОСТ 20276-2012',
      tags: ['полевые', 'штампы', 'модуль'],
      priceTableCode: '1602-0401'
    });
    
    return works;
  }
};

export const section20_blocks: InstructionBlock[] = [
  block_20_01_plate_tests
];

export default section20_blocks;
