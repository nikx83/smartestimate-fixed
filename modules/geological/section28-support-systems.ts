/**
 * Файл: section28-support-systems.ts
 * Назначение: Крепление горных выработок
 */

import type { 
  InstructionBlock, 
  GeologicalInput, 
  WorkItem 
} from './types';

/**
 * Блок 28.1: Крепление шурфов и канав
 */
export const block_28_01_support_open: InstructionBlock = {
  id: 'block-28-01-support-open',
  section: 'Раздел 28: Крепление выработок',
  title: 'Крепление открытых выработок (шурфов, траншей)',
  description: 'Предотвращение обрушения стенок выработок',
  priority: 46,
  tags: ['горные-работы', 'крепление', 'безопасность'],
  
  condition: (input: GeologicalInput) => {
    return (input.requiresShafts === true || 
            input.linearLength !== undefined) &&
           (input.soilTypes?.includes('песчаные') || 
            input.hasHighWaterTable === true);
  },
  
  variants: [
    {
      id: 'variant-support-open',
      priority: 'ОБЯЗАТЕЛЬНЫЙ',
      normative: {
        document: 'СНиП 12-03-2001',
        section: 'Безопасность труда в строительстве',
        priority: 'ОБЯЗАТЕЛЬНЫЙ'
      },
      recommendation:
        '**КРЕПЛЕНИЕ ОТКРЫТЫХ ВЫРАБОТОК:**\n\n' +
        
        '**1. КОГДА ТРЕБУЕТСЯ КРЕПЛЕНИЕ:**\n\n' +
        
        '**Обязательно:**\n' +
        '- Глубина >1.5 м в песках рыхлых\n' +
        '- Глубина >2.5 м в песках плотных\n' +
        '- Глубина >3.0 м в глинах пластичных\n' +
        '- Глубина >5.0 м в любых грунтах\n' +
        '- При обводнённости (УГВ в пределах выработки)\n' +
        '- При динамических нагрузках рядом\n' +
        '- При длительном стоянии выработки (>5 дней)\n\n' +
        
        '**Не требуется:**\n' +
        '- При откосах по естественному углу\n' +
        '- В скальных грунтах\n' +
        '- Глубина <1.5 м в плотных грунтах\n' +
        '- Кратковременные работы (<1 день)\n\n' +
        
        '**2. ТИПЫ КРЕПЛЕНИЯ:**\n\n' +
        
        '**А. Сплошное дощатое:**\n' +
        '- Доски толщиной 40-50 мм\n' +
        '- Стойки (брусья) 100×100 мм через 1.0-1.5 м\n' +
        '- Распорки (поперечины) через 0.8-1.2 м по высоте\n' +
        '- Применение: рыхлые пески, обводнённые грунты\n\n' +
        
        '**Б. Разреженное:**\n' +
        '- Доски через 0.2-0.5 м по высоте\n' +
        '- Стойки и распорки как при сплошном\n' +
        '- Применение: глины пластичные, суглинки\n\n' +
        
        '**В. Инвентарное щитовое:**\n' +
        '- Металлические щиты (готовые)\n' +
        '- Размер щита: 1.5×2.0 м\n' +
        '- Распорки винтовые/гидравлические\n' +
        '- Быстрая установка/демонтаж\n' +
        '- Применение: траншеи, коммуникации\n\n' +
        
        '**Г. Шпунтовое:**\n' +
        '- Шпунт Ларсена (металл)\n' +
        '- Забивается вибропогружателем\n' +
        '- Применение: глубокие котлованы, обводнённые грунты\n\n' +
        
        '**3. КОНСТРУКЦИЯ ДЕРЕВЯННОЙ КРЕПИ:**\n\n' +
        
        '**Элементы:**\n' +
        '```\n' +
        '┌─────────────────┐  ← Распорка (100×100)\n' +
        '│                 │\n' +
        '│  ║         ║   │  ← Стойки (100×100)\n' +
        '│  ║ доски   ║   │\n' +
        '│  ║ 40-50мм ║   │  ← Обшивка досками\n' +
        '│  ║         ║   │\n' +
        '└──╨─────────╨───┘\n' +
        '```\n\n' +
        
        '**Расстояния:**\n' +
        '- Между стойками: 1.0-1.5 м\n' +
        '- Между распорками по высоте: 0.8-1.2 м\n' +
        '- Заглубление стоек: 0.3-0.5 м ниже дна\n\n' +
        
        '**4. ПОСЛЕДОВАТЕЛЬНОСТЬ УСТАНОВКИ:**\n\n' +
        
        '**Пошагово:**\n' +
        '1. Отрывка на глубину 0.5-0.8 м\n' +
        '2. Установка первой рамы крепи\n' +
        '3. Заглубление стоек\n' +
        '4. Установка распорок\n' +
        '5. Обшивка досками\n' +
        '6. Углубка на следующие 0.5-0.8 м\n' +
        '7. Установка следующей рамы\n' +
        '8. Повтор до проектной глубины\n\n' +
        
        '**5. МАТЕРИАЛЫ:**\n\n' +
        
        '**На 1 п.м шурфа 2×2 м, глубина 5 м:**\n' +
        '- Доски 40×150 мм: 0.8 м³\n' +
        '- Брусья 100×100 мм: 0.15 м³\n' +
        '- Гвозди 100-150 мм: 2 кг\n' +
        '- Скобы: 0.5 кг\n\n' +
        
        '**6. РАСХОД МАТЕРИАЛОВ:**\n\n' +
        
        '**Сплошное крепление:**\n' +
        '```\n' +
        'Доски = Периметр × Глубина / 0.9\n' +
        'Стойки = (Периметр / 1.5) × Глубина × 0.01 м³\n' +
        'Распорки = Глубина × 2 / 1.0 × 0.01 м³\n' +
        '```\n\n' +
        
        '**Пример для шурфа 2×2×5 м:**\n' +
        '```\n' +
        'Периметр = 8 м\n' +
        'Доски = 8 × 5 / 0.9 ≈ 45 м² = 0.7 м³ (при толщине 40 мм)\n' +
        'Стойки = (8 / 1.5) × 5 × 0.01 ≈ 0.27 м³\n' +
        'Распорки = 5 × 2 / 1.0 × 0.01 ≈ 0.10 м³\n' +
        'Итого: ~1.1 м³ пиломатериалов\n' +
        '```\n\n' +
        
        '**7. ДЕМОНТАЖ КРЕПИ:**\n' +
        '- Послойно при засыпке\n' +
        '- Снизу вверх\n' +
        '- С уплотнением каждого слоя\n' +
        '- Допускается оставление крепи при невозможности извлечения\n\n' +
        
        '**8. ИНВЕНТАРНЫЕ КРЕПИ:**\n\n' +
        
        '**Преимущества:**\n' +
        '- Быстрая установка (30-60 мин)\n' +
        '- Многократное использование (50-100 циклов)\n' +
        '- Регулировка размеров\n' +
        '- Экономия древесины\n\n' +
        
        '**Недостатки:**\n' +
        '- Высокая начальная стоимость\n' +
        '- Требуется транспорт\n' +
        '- Стандартные размеры\n\n' +
        
        '**9. КОНТРОЛЬ КАЧЕСТВА:**\n' +
        '- Вертикальность стоек (отклонение <5%)\n' +
        '- Плотность прилегания досок\n' +
        '- Надёжность распорок (проверка нагрузкой)\n' +
        '- Отсутствие зазоров >5 см\n' +
        '- Ежедневный осмотр крепи\n\n' +
        
        '**10. ТЕХНИКА БЕЗОПАСНОСТИ:**\n\n' +
        
        '**КРИТИЧНО:**\n' +
        '- Установка крепи ПЕРЕД углубкой >1.5 м\n' +
        '- Запрет работы без крепления\n' +
        '- Проверка состояния крепи перед спуском\n' +
        '- Немедленная замена повреждённых элементов\n' +
        '- Запрет подкопа под стойки\n\n' +
        
        '**ВАЖНО:** Крепление - обязательное мероприятие по технике безопасности',
      
      recommendedValues: {
        lumberPerMeter: {
          value: 0.2,
          unit: 'м³/п.м',
          explanation: 'Расход пиломатериалов на 1 п.м глубины'
        }
      }
    }
  ],
  
  calculateValues: (input: GeologicalInput) => {
    // Расчёт объёма крепления для шурфов
    const values = input.requiresShafts ? 
      {
        shafts: 4,
        depthPerShaft: 3
      } : { shafts: 0, depthPerShaft: 0 };
    
    const totalDepth = values.shafts * values.depthPerShaft;
    const lumberVolume = totalDepth * 0.2; // 0.2 м³ на 1 п.м глубины
    
    return {
      supportDepth: {
        value: totalDepth,
        unit: 'п.м',
        explanation: 'Глубина крепления',
        confidence: 85
      },
      lumberVolume: {
        value: lumberVolume,
        unit: 'м³',
        explanation: 'Объём пиломатериалов',
        confidence: 85
      }
    };
  },
  
  generateWorks: (input: GeologicalInput) => {
    const works: WorkItem[] = [];
    const values = block_28_01_support_open.calculateValues!(input);
    
    if (values.supportDepth.value === 0) {
      return works;
    }
    
    const depth = typeof values.supportDepth.value === 'number'
      ? values.supportDepth.value
      : parseFloat(String(values.supportDepth.value));
    
    works.push({
      workId: 'MINING-SUPPORT-01',
      name: 'Крепление открытых выработок',
      description: 
        'Установка деревянной крепи (доски + стойки + распорки). ' +
        'Сплошное или разреженное крепление',
      unit: 'п.м',
      quantity: depth,
      category: 'mandatory',
      module: 'geological',
      priority: 'ОБЯЗАТЕЛЬНЫЙ',
      normativeBase: 'СНиП 12-03-2001',
      tags: ['горные-работы', 'крепление', 'безопасность'],
      priceTableCode: '1602-0303-02'
    });
    
    return works;
  }
};

export const section28_blocks: InstructionBlock[] = [
  block_28_01_support_open
];

export default section28_blocks;
