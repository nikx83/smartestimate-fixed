/**
 * Файл: section29-dewatering.ts
 * Назначение: Водоотлив при проходке выработок
 */

import type { 
  InstructionBlock, 
  GeologicalInput, 
  WorkItem 
} from './types';

/**
 * Блок 29.1: Водоотлив в выработках
 */
export const block_29_01_dewatering: InstructionBlock = {
  id: 'block-29-01-dewatering',
  section: 'Раздел 29: Водоотлив',
  title: 'Водоотлив при проходке горных выработок',
  description: 'Откачка воды из шурфов, канав, подземных выработок',
  priority: 47,
  tags: ['горные-работы', 'водоотлив', 'обводнённость'],
  
  condition: (input: GeologicalInput) => {
    return input.hasGroundwater === true &&
           (input.requiresShafts === true || 
            input.linearLength !== undefined ||
            input.requiresUndergroundWorkings === true);
  },
  
  variants: [
    {
      id: 'variant-dewatering',
      priority: 'ОБЯЗАТЕЛЬНЫЙ',
      normative: {
        document: 'СП РК 1.02-102-2014',
        section: 'Водоотлив',
        priority: 'ОБЯЗАТЕЛЬНЫЙ'
      },
      recommendation:
        '**ВОДООТЛИВ В ГОРНЫХ ВЫРАБОТКАХ:**\n\n' +
        
        '**1. КОГДА ТРЕБУЕТСЯ:**\n' +
        '- Вскрытие водоносного горизонта\n' +
        '- УГВ выше дна выработки\n' +
        '- Атмосферные осадки\n' +
        '- Приток из стенок\n' +
        '- Техническая вода (от бурения)\n\n' +
        
        '**2. ИСТОЧНИКИ ВОДЫ:**\n\n' +
        
        '**А. Подземные воды:**\n' +
        '- Основной приток в глубоких выработках\n' +
        '- Интенсивность: от 0.1 до 50 м³/час\n' +
        '- Непрерывный приток\n\n' +
        
        '**Б. Поверхностные воды:**\n' +
        '- Дождь, снеготаяние\n' +
        '- Периодический приток\n' +
        '- До 5-10 м³/час\n\n' +
        
        '**В. Техническая вода:**\n' +
        '- От бурения, промывки\n' +
        '- 1-3 м³/час\n\n' +
        
        '**3. ОБОРУДОВАНИЕ:**\n\n' +
        
        '**Центробежные насосы (поверхностные):**\n' +
        '- Производительность: 5-50 м³/час\n' +
        '- Напор: 20-60 м\n' +
        '- Применение: шурфы глубиной до 7-8 м\n' +
        '- Установка на поверхности\n' +
        '- Всасывающий рукав в выработку\n\n' +
        
        '**Погружные насосы:**\n' +
        '- Производительность: 10-100 м³/час\n' +
        '- Напор: 10-80 м\n' +
        '- Применение: глубокие шурфы, шахты\n' +
        '- Установка на дне выработки\n' +
        '- Автоматическое включение (поплавок)\n\n' +
        
        '**Мембранные/диафрагменные:**\n' +
        '- Производительность: 1-10 м³/час\n' +
        '- Работа с загрязнённой водой\n' +
        '- Применение: слабые притоки, шлам\n\n' +
        
        '**4. СХЕМА ВОДООТЛИВА:**\n\n' +
        
        '**Для шурфов:**\n' +
        '```\n' +
        '┌─────────┐  ← Насос на поверхности\n' +
        '│  ⚡ N   │\n' +
        '└────┬────┘\n' +
        '     │ рукав\n' +
        '┌────▼────┐\n' +
        '│    ╱╲   │  ← Водосборник (приямок)\n' +
        '│   ╱  ╲  │     в углу шурфа\n' +
        '│  │ ≈≈ │ │  ← 0.5×0.5×0.5 м\n' +
        '└──┴────┴─┘\n' +
        '```\n\n' +
        
        '**Для канав:**\n' +
        '- Водосборник через каждые 50-100 м\n' +
        '- Дренажная канавка по дну (уклон 0.003)\n' +
        '- Насос переставляется по мере углубки\n\n' +
        
        '**Для подземных выработок:**\n' +
        '- Канавка по почве (боковая)\n' +
        '- Водосборник у устья\n' +
        '- Насос стационарный\n\n' +
        
        '**5. РАСЧЁТ ПРОИЗВОДИТЕЛЬНОСТИ:**\n\n' +
        
        '**Приток подземных вод:**\n' +
        '```\n' +
        'Q = K × F × I\n' +
        '\n' +
        'где:\n' +
        'K - коэффициент фильтрации, м/сут\n' +
        'F - площадь фильтрации, м²\n' +
        'I - гидравлический градиент (обычно ≈1)\n' +
        '\n' +
        'Пример:\n' +
        'K = 5 м/сут (пески средние)\n' +
        'F = 10 м² (дно+стенки шурфа 2×2×3м)\n' +
        'Q = 5 × 10 × 1 = 50 м³/сут ≈ 2 м³/час\n' +
        '```\n\n' +
        
        '**Производительность насоса:**\n' +
        '```\n' +
        'Qнасоса ≥ 1.5 × Qпритока\n' +
        '\n' +
        'Коэффициент 1.5 - запас на пиковые притоки\n' +
        '```\n\n' +
        
        '**6. УСТРОЙСТВО ВОДОСБОРНИКА:**\n\n' +
        
        '**Приямок (зумпф):**\n' +
        '- Размер: 0.5×0.5×0.5 м\n' +
        '- Расположение: угол выработки\n' +
        '- Заглубление: 0.3-0.5 м ниже дна\n' +
        '- Обшивка досками или без\n' +
        '- Решётка сверху (от крупных частиц)\n\n' +
        
        '**Дренажная канавка:**\n' +
        '- Сечение: 0.2×0.2 м\n' +
        '- Уклон к приямку: 0.003-0.005 (3-5‰)\n' +
        '- Вдоль борта выработки\n\n' +
        
        '**7. РЕЖИМ РАБОТЫ:**\n\n' +
        
        '**Непрерывный:**\n' +
        '- При интенсивных притоках >5 м³/час\n' +
        '- Подземные выработки\n' +
        '- Глубокие шурфы\n\n' +
        
        '**Периодический:**\n' +
        '- Слабые притоки <5 м³/час\n' +
        '- Включение 2-4 раза в смену\n' +
        '- Работа 15-60 минут\n\n' +
        
        '**Автоматический:**\n' +
        '- Поплавковый выключатель\n' +
        '- Включение при уровне +20 см\n' +
        '- Выключение при уровне -10 см\n\n' +
        
        '**8. ОТВОД ВОДЫ:**\n' +
        '- Рукав/труба на поверхность\n' +
        '- Сброс на расстояние >5 м от устья\n' +
        '- В канаву, кювет, ливнёвку\n' +
        '- Не допускать замачивания бортов выработки\n\n' +
        
        '**9. ПРОИЗВОДИТЕЛЬНОСТЬ РАБОТ:**\n\n' +
        
        '**Снижение темпов при водоотливе:**\n' +
        '```\n' +
        'Без воды: 5 м³/день (выемка грунта)\n' +
        'С водоотливом: 3-4 м³/день\n' +
        '\n' +
        'Снижение на 20-40%\n' +
        '```\n\n' +
        
        '**Дополнительное время:**\n' +
        '- Установка/демонтаж насоса: 2-4 часа\n' +
        '- Устройство приямка: 4-6 часов\n' +
        '- Обслуживание насоса: 0.5 час/сутки\n\n' +
        
        '**10. СТОИМОСТЬ:**\n\n' +
        
        '**Состав затрат:**\n' +
        '- Аренда насоса: 5000-15000 тенге/сутки\n' +
        '- Электроэнергия: 50-200 кВт·ч/сутки\n' +
        '- Расходные материалы (рукава): 10000 тенге\n' +
        '- Обслуживание: 5000 тенге/сутки\n\n' +
        
        '**Итого:** 10000-25000 тенге/сутки на одну выработку\n\n' +
        
        '**11. ПРЕДОТВРАЩЕНИЕ ПРИТОКОВ:**\n\n' +
        
        '**Методы снижения:**\n' +
        '- Иглофильтры вокруг выработки\n' +
        '- Скважины понижения УГВ\n' +
        '- Тампонаж водоносных слоёв\n' +
        '- Плотная крепь\n' +
        '- Гидроизоляция стенок\n\n' +
        
        '**12. УЧЁТ ВОДООТЛИВА:**\n' +
        '- Журнал водоотлива\n' +
        '- Время работы насоса (машино-часы)\n' +
        '- Объём откачанной воды (м³)\n' +
        '- Интенсивность притока (м³/час)\n' +
        '- Расход электроэнергии (кВт·ч)\n\n' +
        
        '**13. ТЕХНИКА БЕЗОПАСНОСТИ:**\n' +
        '- Электрооборудование 36 В (в выработке)\n' +
        '- Заземление насоса\n' +
        '- Защита от поражения током (УЗО)\n' +
        '- Регулярная проверка изоляции\n' +
        '- Запрет работы в воде при токе >36 В\n\n' +
        
        '**ВАЖНО:** Водоотлив - обязательная операция при обводнённых условиях',
      
      recommendedValues: {
        pumpCapacity: {
          value: 10,
          unit: 'м³/час',
          explanation: 'Типичная производительность насоса'
        },
        operatingTime: {
          value: 8,
          unit: 'час/сутки',
          explanation: 'Время работы при периодическом режиме'
        }
      }
    }
  ],
  
  calculateValues: (input: GeologicalInput) => {
    if (!input.hasGroundwater) {
      return {
        dewateringDays: {
          value: 0,
          unit: 'машино-суток',
          explanation: 'Водоотлив не требуется',
          confidence: 100
        }
      };
    }
    
    // Оценка необходимости водоотлива
    const waterDepth = input.groundwaterDepth || 10;
    const workDepth = input.foundationDepth || 3;
    
    if (waterDepth > workDepth) {
      return {
        dewateringDays: {
          value: 0,
          unit: 'машино-суток',
          explanation: 'УГВ ниже дна выработок',
          confidence: 95
        }
      };
    }
    
    // Количество выработок с водоотливом
    const shaftsCount = input.requiresShafts ? 3 : 0;
    const trenchesCount = input.linearLength ? Math.ceil(input.linearLength / 300) : 0;
    
    const totalWorkings = shaftsCount + trenchesCount;
    
    // Дней проходки на выработку
    const daysPerWorking = 10;
    
    // Общее время водоотлива
    const dewateringDays = totalWorkings * daysPerWorking;
    
    return {
      dewateringDays: {
        value: dewateringDays,
        unit: 'машино-суток',
        explanation: 'Продолжительность водоотлива',
        confidence: 80
      },
      numberOfPumps: {
        value: Math.min(totalWorkings, 3), // максимум 3 насоса одновременно
        unit: 'насосов',
        explanation: 'Количество насосов',
        confidence: 85
      }
    };
  },
  
  generateWorks: (input: GeologicalInput) => {
    const works: WorkItem[] = [];
    const values = block_29_01_dewatering.calculateValues!(input);
    
    if (values.dewateringDays.value === 0) {
      return works;
    }
    
    const days = typeof values.dewateringDays.value === 'number'
      ? values.dewateringDays.value
      : parseFloat(String(values.dewateringDays.value));
    
    works.push({
      workId: 'MINING-DEWATER-01',
      name: 'Водоотлив при проходке выработок',
      description: 
        'Откачка воды центробежным/погружным насосом Q=10 м³/час. ' +
        'Устройство водосборника, рукава, обслуживание',
      unit: 'машино-сутки',
      quantity: days,
      category: 'mandatory',
      module: 'geological',
      priority: 'ОБЯЗАТЕЛЬНЫЙ',
      normativeBase: 'СП РК 1.02-102-2014',
      tags: ['горные-работы', 'водоотлив', 'обводнённость'],
      priceTableCode: '1602-0303-03'
    });
    
    return works;
  }
};

export const section29_blocks: InstructionBlock[] = [
  block_29_01_dewatering
];

export default section29_blocks;
