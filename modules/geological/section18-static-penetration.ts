/**
 * Файл: section18-static-penetration.ts
 * Назначение: Статическое зондирование грунтов (CPT)
 */

import type { 
  InstructionBlock, 
  GeologicalInput, 
  WorkItem 
} from './types';

/**
 * Блок 18.1: Статическое зондирование
 */
export const block_18_01_cpt: InstructionBlock = {
  id: 'block-18-01-static-penetration',
  section: 'Раздел 18: Статическое зондирование',
  title: 'Статическое зондирование грунтов (CPT)',
  description: 'Определение механических свойств грунтов зондированием',
  priority: 30,
  tags: ['полевые', 'зондирование', 'CPT'],
  
  condition: (input: GeologicalInput) => {
    return (input.soilTypes?.includes('глинистые') || 
            input.soilTypes?.includes('песчаные')) &&
           input.geotechnicalCategory !== 'I';
  },
  
  variants: [
    {
      id: 'variant-cpt-standard',
      priority: 'РЕКОМЕНДУЕМЫЙ',
      normative: {
        document: 'ГОСТ 19912-2012',
        section: 'Статическое зондирование',
        priority: 'РЕКОМЕНДУЕМЫЙ'
      },
      recommendation:
        '**СТАТИЧЕСКОЕ ЗОНДИРОВАНИЕ (CPT):**\n\n' +
        
        '**1. СУЩНОСТЬ МЕТОДА:**\n' +
        '- Вдавливание конуса в грунт с постоянной скоростью\n' +
        '- Непрерывная запись сопротивления внедрению\n' +
        '- Получение непрерывного разреза по глубине\n' +
        '- Скорость: 1.2-2.0 м/мин\n\n' +
        
        '**2. ТИПЫ ЗОНДОВ:**\n\n' +
        
        '**А. Механический конус:**\n' +
        '- Площадь основания: 10 см² (стандарт)\n' +
        '- Угол при вершине: 60°\n' +
        '- Измерение: qc - сопротивление конуса\n' +
        '- Применение: простые грунты\n\n' +
        
        '**Б. Электрический конус (CPTU):**\n' +
        '- qc - сопротивление конуса (МПа)\n' +
        '- fs - сопротивление трению по муфте (кПа)\n' +
        '- u - поровое давление (кПа)\n' +
        '- Датчики: тензометрические\n' +
        '- Частота записи: 20-50 Гц\n\n' +
        
        '**В. Сейсмоконус (SCPTU):**\n' +
        '- + Геофоны для измерения Vs\n' +
        '- Определение динамического модуля сдвига\n' +
        '- Применение: сейсмостойкое проектирование\n\n' +
        
        '**3. ОПРЕДЕЛЯЕМЫЕ ПАРАМЕТРЫ:**\n\n' +
        
        '**Для песчаных грунтов:**\n' +
        '```\n' +
        'φ = 17.6° + 11.0 × log(qc)    (по Robertson)\n' +
        'E = α × qc                     (модуль деформации)\n' +
        '\n' +
        'где α = 2-8 (зависит от типа песка)\n' +
        '```\n\n' +
        
        '**Для глинистых грунтов:**\n' +
        '```\n' +
        'cu = (qc - σv0) / Nkt          (недренированная прочность)\n' +
        '\n' +
        'где:\n' +
        'Nkt = 10-20 (конусный фактор)\n' +
        'σv0 - вертикальное напряжение\n' +
        '```\n\n' +
        
        '**Коэффициент трения:**\n' +
        '```\n' +
        'Rf = (fs / qc) × 100%\n' +
        '```\n\n' +
        
        '**4. КЛАССИФИКАЦИЯ ГРУНТОВ ПО CPT:**\n\n' +
        
        '**По графику Robertson (1990):**\n' +
        '- Ось X: log(qc/σv0)\n' +
        '- Ось Y: Rf (%)\n' +
        '- 12 зон грунтов:\n' +
        '  * Зона 1: Чувствительная глина\n' +
        '  * Зона 2: Органические грунты\n' +
        '  * Зона 3-4: Глины\n' +
        '  * Зона 5-6: Суглинки, супеси\n' +
        '  * Зона 7-9: Пески\n' +
        '  * Зона 10-12: Гравелистые грунты\n\n' +
        
        '**5. ГЛУБИНА ЗОНДИРОВАНИЯ:**\n' +
        '- Стандартно: 15-20 м\n' +
        '- Максимум: до 40 м (мощные установки)\n' +
        '- Проходимость:\n' +
        '  * Глины: отлично\n' +
        '  * Суглинки, супеси: хорошо\n' +
        '  * Пески: хорошо до плотных\n' +
        '  * Гравий, галька: ограничена\n' +
        '  * Скальные: невозможно\n\n' +
        
        '**6. КОЛИЧЕСТВО ТОЧЕК ЗОНДИРОВАНИЯ:**\n\n' +
        
        '**Для площадных объектов:**\n' +
        '```\n' +
        'n = (F / 400) × k\n' +
        '\n' +
        'где:\n' +
        'F - площадь, м²\n' +
        'k = 1.0 - I категория сложности\n' +
        'k = 1.5 - II категория\n' +
        'k = 2.0 - III категория\n' +
        '```\n\n' +
        
        '**Минимум:** 3-5 точек на объект\n\n' +
        
        '**Сетка:** 20×20 м (I кат), 15×15 м (II кат), 10×10 м (III кат)\n\n' +
        
        '**7. КОРРЕЛЯЦИЯ С ЛАБОРАТОРНЫМИ ДАННЫМИ:**\n' +
        '- Обязательно 2-3 скважины с отбором образцов\n' +
        '- Лабораторные испытания для калибровки\n' +
        '- Построение региональных корреляций\n\n' +
        
        '**8. ПРЕИМУЩЕСТВА CPT:**\n' +
        '- Непрерывный разрез (через каждые 2-5 см)\n' +
        '- Быстрота (100-200 м/день)\n' +
        '- Объективность (нет субъективизма бурильщика)\n' +
        '- Повторяемость результатов\n' +
        '- Выявление тонких прослоев\n\n' +
        
        '**9. ОГРАНИЧЕНИЯ:**\n' +
        '- Не проходит скальные грунты\n' +
        '- Затруднено в крупнообломочных\n' +
        '- Нет визуального контроля грунта\n' +
        '- Требует калибровки по скважинам\n\n' +
        
        '**10. ПРИМЕНЕНИЕ РЕЗУЛЬТАТОВ:**\n' +
        '- Инженерно-геологическое районирование\n' +
        '- Оценка несущей способности свай\n' +
        '- Расчёт осадок фундаментов\n' +
        '- Выявление слабых прослоев\n' +
        '- Контроль уплотнения насыпей\n\n' +
        
        '**ВАЖНО:** CPT не заменяет бурение, а дополняет его',
      
      recommendedValues: {
        pointsPerHa: {
          value: 2.5,
          unit: 'точек/га',
          explanation: 'Сетка 20×20м'
        },
        depthStandard: {
          value: 15,
          unit: 'м',
          explanation: 'Стандартная глубина'
        }
      }
    }
  ],
  
  calculateValues: (input: GeologicalInput) => {
    const area = input.buildingArea || 1000;
    const category = input.geotechnicalCategory || 'II';
    
    // Коэффициент по категории
    const kCategory = category === 'I' ? 1.0 : category === 'II' ? 1.5 : 2.0;
    
    // Количество точек
    const points = Math.max(3, Math.ceil((area / 400) * kCategory));
    
    // Глубина
    const depth = input.foundationDepth ? input.foundationDepth + 10 : 15;
    
    return {
      cptPoints: {
        value: points,
        unit: 'точек',
        explanation: 'Точки статического зондирования',
        confidence: 85
      },
      averageDepth: {
        value: depth,
        unit: 'м',
        explanation: 'Средняя глубина зондирования',
        confidence: 90
      },
      totalMeters: {
        value: points * depth,
        unit: 'п.м',
        explanation: 'Общий объём зондирования',
        confidence: 85
      }
    };
  },
  
  generateWorks: (input: GeologicalInput) => {
    const works: WorkItem[] = [];
    const values = block_18_01_cpt.calculateValues!(input);
    
    const meters = typeof values.totalMeters.value === 'number'
      ? values.totalMeters.value
      : parseFloat(String(values.totalMeters.value));
    
    works.push({
      workId: 'FIELD-CPT-01',
      name: 'Статическое зондирование грунтов (CPT)',
      description: 
        'Зондирование электрическим конусом. Определение qc, fs, u. ' +
        'Непрерывная запись по глубине, построение графиков',
      unit: 'п.м',
      quantity: meters,
      category: 'recommended',
      module: 'geological',
      priority: 'РЕКОМЕНДУЕМЫЙ',
      normativeBase: 'ГОСТ 19912-2012',
      tags: ['полевые', 'зондирование'],
      priceTableCode: '1602-0405'
    });
    
    return works;
  }
};

export const section18_blocks: InstructionBlock[] = [
  block_18_01_cpt
];

export default section18_blocks;
