/**
 * Файл: section26-trenches.ts
 * Назначение: Проходка канав и траншей
 */

import type { 
  InstructionBlock, 
  GeologicalInput, 
  WorkItem 
} from './types';

/**
 * Блок 26.1: Канавы и траншеи
 */
export const block_26_01_trenches: InstructionBlock = {
  id: 'block-26-01-trenches',
  section: 'Раздел 26: Канавы и траншеи',
  title: 'Проходка канав и траншей',
  description: 'Протяжённые открытые выработки для линейных изысканий',
  priority: 43,
  tags: ['горные-работы', 'канавы', 'траншеи', 'линейные'],
  
  condition: (input: GeologicalInput) => {
    return input.linearLength !== undefined && input.linearLength > 0;
  },
  
  variants: [
    {
      id: 'variant-trenches',
      priority: 'ОБЯЗАТЕЛЬНЫЙ',
      normative: {
        document: 'СП РК 1.02-102-2014',
        section: 'Горнопроходческие работы',
        priority: 'ОБЯЗАТЕЛЬНЫЙ'
      },
      recommendation:
        '**ПРОХОДКА КАНАВ И ТРАНШЕЙ:**\n\n' +
        
        '**1. НАЗНАЧЕНИЕ:**\n' +
        '- Изучение грунтов вдоль линейных объектов\n' +
        '- Трассы дорог, трубопроводов, ЛЭП\n' +
        '- Непрерывное вскрытие разреза по длине\n' +
        '- Отбор образцов по всей трассе\n' +
        '- Выявление неоднородностей\n\n' +
        
        '**2. ТИПЫ ВЫРАБОТОК:**\n\n' +
        
        '**А. Канава:**\n' +
        '- Ширина по дну: 0.6-1.0 м\n' +
        '- Ширина по верху: 1.5-2.5 м (с откосами)\n' +
        '- Глубина: 1.5-3.0 м\n' +
        '- Откосы: 1:0.5 до 1:1\n' +
        '- Длина: 10-100 м\n\n' +
        
        '**Б. Траншея:**\n' +
        '- Ширина: 0.4-0.6 м (узкая)\n' +
        '- Глубина: 1.0-2.0 м\n' +
        '- Вертикальные стенки (с креплением)\n' +
        '- Длина: 5-50 м\n\n' +
        
        '**В. Врез:**\n' +
        '- Короткая канава (3-10 м)\n' +
        '- На участках обнажений\n' +
        '- Для зачистки естественных выходов\n\n' +
        
        '**Г. Расчистка:**\n' +
        '- Зачистка естественных обнажений\n' +
        '- Откосов, оврагов, береговых склонов\n' +
        '- Удаление осыпей и растительности\n\n' +
        
        '**3. МЕТОДИКА ПРОХОДКИ:**\n\n' +
        
        '**Ручная (до 100 м):**\n' +
        '- Копка лопатой\n' +
        '- Отвал грунта вдоль борта\n' +
        '- Зачистка стенок\n' +
        '- Производительность: 5-10 м/день (канава 2×1 м)\n\n' +
        
        '**Механизированная (>100 м):**\n' +
        '- Экскаватор (ковш 0.25-0.65 м³)\n' +
        '- Траншеекопатель (узкие траншеи)\n' +
        '- Производительность: 50-200 м/день\n' +
        '- Ручная зачистка стенок после\n\n' +
        
        '**4. КРЕПЛЕНИЕ:**\n\n' +
        
        '**Канавы (с откосами):**\n' +
        '- Крепление обычно не требуется\n' +
        '- Угол откоса по грунтам:\n' +
        '  * Пески: 1:1.5 (34°)\n' +
        '  * Суглинки: 1:1 (45°)\n' +
        '  * Глины: 1:0.75 (53°)\n\n' +
        
        '**Траншеи (вертикальные стенки):**\n' +
        '- Крепление инвентарными щитами\n' +
        '- Или досками + распорки\n' +
        '- Обязательно при глубине >1.5 м\n\n' +
        
        '**5. ОБЪЁМ ВЫЕМКИ:**\n\n' +
        
        '**Канава с откосами:**\n' +
        '```\n' +
        'V = L × h × (b + h/k) / 2\n' +
        '\n' +
        'где:\n' +
        'L - длина, м\n' +
        'h - глубина, м\n' +
        'b - ширина по дну, м\n' +
        'k - коэффициент откоса\n' +
        '\n' +
        'Пример: L=50м, h=2м, b=0.8м, k=1\n' +
        'V = 50 × 2 × (0.8 + 2/1) / 2 = 140 м³\n' +
        '```\n\n' +
        
        '**Траншея:**\n' +
        '```\n' +
        'V = L × h × b\n' +
        '\n' +
        'Пример: L=20м, h=1.5м, b=0.5м\n' +
        'V = 20 × 1.5 × 0.5 = 15 м³\n' +
        '```\n\n' +
        
        '**6. КОЛИЧЕСТВО:**\n\n' +
        
        '**Для линейных объектов:**\n' +
        '- Канавы: через 200-500 м по трассе\n' +
        '- Врезы: через 100-200 м\n' +
        '- Расчистки: все естественные обнажения\n\n' +
        
        '**Длина выработок:**\n' +
        '- Канава: 20-50 м типичная\n' +
        '- Врез: 5-10 м\n' +
        '- Расчистка: по ситуации\n\n' +
        
        '**7. ОТБОР ОБРАЗЦОВ:**\n' +
        '- Через каждые 5-10 м по длине канавы\n' +
        '- С каждого слоя по стенке\n' +
        '- Минимум 5-10 образцов из канавы 50 м\n' +
        '- Ненарушенного сложения из зачищенных стенок\n\n' +
        
        '**8. ДОКУМЕНТАЦИЯ:**\n' +
        '- План трассы с расположением канав\n' +
        '- Профили вдоль трассы\n' +
        '- Зарисовки стенок канав\n' +
        '- Фотографии характерных участков\n' +
        '- Геологическая привязка\n\n' +
        
        '**9. ПРОИЗВОДИТЕЛЬНОСТЬ:**\n\n' +
        
        '**Ручная проходка:**\n' +
        '- Канава 2×1 м в суглинках: 5-8 м/день\n' +
        '- Траншея 1.5×0.5 м: 10-15 м/день\n' +
        '- Врез 3×1 м: 3-5 вреза/день\n\n' +
        
        '**Механизированная:**\n' +
        '- Экскаватор ЭО-2621: 100-150 м/день\n' +
        '- Траншеекопатель: 200-300 м/день\n\n' +
        
        '**10. ЛИКВИДАЦИЯ:**\n' +
        '- Засыпка грунтом из отвалов\n' +
        '- Послойное уплотнение (на дорогах)\n' +
        '- Планировка поверхности\n' +
        '- Восстановление растительного слоя\n\n' +
        
        '**11. ТЕХНИКА БЕЗОПАСНОСТИ:**\n' +
        '- Откосы по углам естественного откоса\n' +
        '- Крепление при вертикальных стенках >1.5 м\n' +
        '- Отвал грунта не ближе 0.5 м от бровки\n' +
        '- Запрет нахождения людей в зоне работы экскаватора\n' +
        '- Ограждение на пересечениях с дорогами\n\n' +
        
        '**12. СЕЗОННОСТЬ:**\n' +
        '- Оптимально: тёплое время года\n' +
        '- Зимой: затруднена в мёрзлых грунтах\n' +
        '- Весна/осень: проблемы с водоотливом\n\n' +
        
        '**ПРИМЕНЕНИЕ:** Обязательно для линейных объектов (трассы, трубопроводы)',
      
      recommendedValues: {
        spacing: {
          value: 300,
          unit: 'м',
          explanation: 'Расстояние между канавами'
        },
        trenchLength: {
          value: 30,
          unit: 'м',
          explanation: 'Типичная длина канавы'
        }
      }
    }
  ],
  
  calculateValues: (input: GeologicalInput) => {
    const linearLength = input.linearLength || 0;
    
    if (linearLength === 0) {
      return {
        trenches: {
          value: 0,
          unit: 'канав',
          explanation: 'Не требуется (не линейный объект)',
          confidence: 100
        }
      };
    }
    
    // Количество канав через каждые 300 м
    const numberOfTrenches = Math.ceil(linearLength / 300);
    
    // Длина каждой канавы
    const trenchLength = 30;
    
    // Общая длина канав
    const totalLength = numberOfTrenches * trenchLength;
    
    // Объём выемки (канава 2×0.8 м с откосами 1:1)
    const volumePerMeter = 2 * (0.8 + 2/1) / 2; // ≈2.8 м³/м
    const totalVolume = totalLength * volumePerMeter;
    
    return {
      trenches: {
        value: numberOfTrenches,
        unit: 'канав',
        explanation: 'Количество канав по трассе',
        confidence: 90
      },
      totalLength: {
        value: totalLength,
        unit: 'п.м',
        explanation: 'Общая длина канав',
        confidence: 90
      },
      totalVolume: {
        value: totalVolume,
        unit: 'м³',
        explanation: 'Общий объём выемки',
        confidence: 85
      }
    };
  },
  
  generateWorks: (input: GeologicalInput) => {
    const works: WorkItem[] = [];
    const values = block_26_01_trenches.calculateValues!(input);
    
    if (values.trenches.value === 0) {
      return works;
    }
    
    const volume = typeof values.totalVolume.value === 'number'
      ? values.totalVolume.value
      : parseFloat(String(values.totalVolume.value));
    
    works.push({
      workId: 'MINING-TRENCH-01',
      name: 'Проходка канав',
      description: 
        'Проходка канав размером 2.0×0.8 м (по дну) с откосами 1:1. ' +
        'Зачистка стенок, описание грунтов, отбор образцов, засыпка',
      unit: 'м³',
      quantity: volume,
      category: 'mandatory',
      module: 'geological',
      priority: 'ОБЯЗАТЕЛЬНЫЙ',
      normativeBase: 'СП РК 1.02-102-2014',
      tags: ['горные-работы', 'канавы', 'линейные'],
      priceTableCode: '1602-0301-02'
    });
    
    return works;
  }
};

export const section26_blocks: InstructionBlock[] = [
  block_26_01_trenches
];

export default section26_blocks;
