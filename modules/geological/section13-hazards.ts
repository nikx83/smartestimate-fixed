/**
 * Файл: /modules/geological/section13-hazards.ts
 * Назначение: Блоки инструкции для исследований опасных геологических процессов
 * 
 * ПРИМЕЧАНИЕ: Это Раздел 13 инструкции, но файл называется section10
 * 
 * Описание:
 * Реализация требований к исследованиям опасных геологических процессов - карст,
 * оползни, подтопление, сейсмичность согласно СП РК 1.02-102-2014, раздел 9
 * 
 * Содержит 4 блока:
 * - 13.1: Карст и суффозия
 * - 13.2: Оползни и склоновые процессы
 * - 13.3: Подтопление
 * - 13.4: Сейсмические исследования
 */

import type { InstructionBlock, GeologicalInput, InstructionVariant, WorkItem } from '../rules-engine/types';

// ============================================================================
// РАЗДЕЛ 13.1: КАРСТ И СУФФОЗИЯ
// ============================================================================

/**
 * Блок 13.1: Исследования в районах карста и суффозии
 */
export const block_13_01_karst: InstructionBlock = {
  id: 'block-13-01-karst-suffosion-investigation',
  section: 'Раздел 13: Опасные геологические процессы',
  title: 'Исследования в районах карста и суффозии',
  description: 'Комплекс работ для выявления и изучения карстовых полостей',
  priority: 130,
  tags: ['опасные-процессы', 'карст', 'суффозия'],
  
  condition: (input: GeologicalInput) => {
    return (
      input.hazards &&
      input.hazards.some(hazard => {
        const h = hazard.toLowerCase();
        return h.includes('карст') || h.includes('суффоз');
      })
    );
  },
  
  variants: [
    {
      id: 'variant-mandatory-sp-rk-102',
      priority: 'ОБЯЗАТЕЛЬНЫЙ',
      normative: {
        document: 'СП РК 1.02-102-2014',
        section: 'раздел 9.13',
        priority: 'ОБЯЗАТЕЛЬНЫЙ'
      },
      recommendation: 'Для районов развития карста и суффозии обязательно включить:\n' +
        '**Съёмочные работы:**\n' +
        '- Карстологическая съёмка масштаба 1:10000-1:2000\n' +
        '- Дешифрирование аэрофото- и космоснимков\n' +
        '**Геофизические исследования:**\n' +
        '- Вертикальное электрическое зондирование (ВЭЗ)\n' +
        '- Георадарное профилирование для выявления полостей\n' +
        '- Сейсморазведка (при необходимости)\n' +
        '**Исследование полостей:**\n' +
        '- Спелеологические исследования доступных карстовых полостей\n' +
        '- Документирование пещер, воронок, провалов\n' +
        '**Буровые работы:**\n' +
        '- Дополнительное бурение в аномальных зонах\n' +
        '- Увеличенная плотность скважин\n' +
        '**Мониторинг:**\n' +
        '- Режимные наблюдения за развитием карста',
      recommendedValues: {
        surveyScale: {
          value: '1:10000',
          unit: 'масштаб',
          explanation: 'Карстологическая съёмка'
        },
        geophysics: {
          value: ['ВЭЗ', 'георадар'],
          unit: 'методы',
          explanation: 'Обязательные геофизические методы'
        }
      },
      warnings: [
        'Карст - один из самых опасных геологических процессов',
        'Может привести к провалам и обрушениям',
        'Требуется комплексный подход: съёмка + геофизика + бурение'
      ]
    }
  ],
  
  generateWorks: (input: GeologicalInput) => {
    return [
      {
        workId: 'karst-survey',
        name: 'Карстологическая съёмка',
        category: 'mandatory',
        module: 'geological',
        quantity: 1,
        unit: 'комплекс',
        normativeBase: 'СП РК 1.02-102-2014, раздел 9.13',
        description: 'Масштаб 1:10000, дешифрирование снимков',
        priority: 'ОБЯЗАТЕЛЬНЫЙ',
        tags: ['карст', 'съёмка']
      },
      {
        workId: 'karst-geophysics',
        name: 'Геофизические исследования для выявления карстовых полостей',
        category: 'mandatory',
        module: 'geological',
        quantity: 1,
        unit: 'комплекс',
        normativeBase: 'СП РК 1.02-102-2014, раздел 9.13',
        description: 'ВЭЗ, георадарное профилирование',
        priority: 'ОБЯЗАТЕЛЬНЫЙ',
        tags: ['карст', 'геофизика', 'ВЭЗ', 'георадар']
      },
      {
        workId: 'karst-speleology',
        name: 'Спелеологические исследования доступных полостей',
        category: 'mandatory',
        module: 'geological',
        quantity: 1,
        unit: 'комплекс',
        normativeBase: 'СП РК 1.02-102-2014, раздел 9.13',
        description: 'Документирование пещер, воронок, провалов',
        priority: 'ОБЯЗАТЕЛЬНЫЙ',
        tags: ['карст', 'спелеология']
      },
      {
        workId: 'karst-additional-drilling',
        name: 'Дополнительное бурение в карстоопасных зонах',
        category: 'mandatory',
        module: 'geological',
        quantity: 5,
        unit: 'скважин',
        normativeBase: 'СП РК 1.02-102-2014, раздел 9.13',
        description: 'Увеличенная плотность скважин в аномальных зонах',
        priority: 'ОБЯЗАТЕЛЬНЫЙ',
        tags: ['карст', 'бурение']
      },
      {
        workId: 'karst-monitoring',
        name: 'Режимные наблюдения за развитием карста',
        category: 'recommended',
        module: 'geological',
        quantity: 12,
        unit: 'месяцев',
        normativeBase: 'СП РК 1.02-102-2014, раздел 9.13',
        description: 'Мониторинг провалов, воронок, изменений',
        priority: 'РЕКОМЕНДУЕМЫЙ',
        tags: ['карст', 'мониторинг']
      }
    ];
  }
};

// ============================================================================
// РАЗДЕЛ 13.2: ОПОЛЗНИ И СКЛОНОВЫЕ ПРОЦЕССЫ
// ============================================================================

/**
 * Блок 13.2: Исследования оползней и склоновых процессов
 */
export const block_13_02_landslides: InstructionBlock = {
  id: 'block-13-02-landslides-investigation',
  section: 'Раздел 13: Опасные геологические процессы',
  title: 'Исследования оползней и склоновых процессов',
  description: 'Оползневая съёмка, инклинометрия, расчёты устойчивости',
  priority: 131,
  tags: ['опасные-процессы', 'оползни', 'склоны'],
  
  condition: (input: GeologicalInput) => {
    return (
      input.hazards &&
      input.hazards.some(hazard => {
        const h = hazard.toLowerCase();
        return h.includes('оползн') || h.includes('склон');
      })
    );
  },
  
  variants: [
    {
      id: 'variant-mandatory-sp-rk-102',
      priority: 'ОБЯЗАТЕЛЬНЫЙ',
      normative: {
        document: 'СП РК 1.02-102-2014',
        section: 'раздел 9.11',
        priority: 'ОБЯЗАТЕЛЬНЫЙ'
      },
      recommendation: 'Для оползневых и потенциально оползневых участков обязательно включить:\n' +
        '**Съёмочные работы:**\n' +
        '- Специальная оползневая съёмка масштаба 1:2000-1:500\n' +
        '- Выявление оползневых тел, трещин отрыва, зон деформаций\n' +
        '**Инклинометрия:**\n' +
        '- Инклинометрические наблюдения в скважинах для определения глубины поверхности скольжения\n' +
        '- Не менее 3-5 инклинометрических скважин на оползень\n' +
        '**Лабораторные испытания:**\n' +
        '- Определение прочностных характеристик грунтов по поверхностям скольжения (остаточная прочность)\n' +
        '- Испытания на срез по ослабленным поверхностям\n' +
        '**Расчёты:**\n' +
        '- Расчёты устойчивости склонов (коэффициент запаса устойчивости)\n' +
        '- Прогноз развития оползневого процесса\n' +
        '**Мониторинг:**\n' +
        '- Режимные наблюдения за деформациями и подвижками (маркшейдерские, геодезические)',
      recommendedValues: {
        surveyScale: {
          value: '1:2000',
          unit: 'масштаб',
          explanation: 'Оползневая съёмка'
        },
        inclinometers: {
          value: 4,
          min: 3,
          max: 5,
          unit: 'скважин',
          explanation: 'На один оползень'
        }
      }
    },
    {
      id: 'variant-hydro-vsn',
      priority: 'СПРАВОЧНЫЙ',
      normative: {
        document: 'ВСН 34.2-88',
        section: 'п. 10.1',
        priority: 'СПРАВОЧНЫЙ'
      },
      recommendation: 'Для гидроэнергетических объектов дополнительно:\n' +
        '- Изучение оползней в бортах водохранилища\n' +
        '- Прогноз переработки берегов\n' +
        '- Волновые подмывы\n' +
        '- Влияние колебаний уровня воды на устойчивость склонов',
      note: 'Для ГЭС и водохранилищ'
    }
  ],
  
  generateWorks: (input: GeologicalInput, selectedVariant: InstructionVariant) => {
    const works: WorkItem[] = [
      {
        workId: 'landslide-survey',
        name: 'Специальная оползневая съёмка',
        category: 'mandatory',
        module: 'geological',
        quantity: 1,
        unit: 'комплекс',
        normativeBase: 'СП РК 1.02-102-2014, раздел 9.11',
        description: 'Масштаб 1:2000, выявление оползневых тел',
        priority: 'ОБЯЗАТЕЛЬНЫЙ',
        tags: ['оползни', 'съёмка']
      },
      {
        workId: 'landslide-inclinometry',
        name: 'Инклинометрические наблюдения в скважинах',
        category: 'mandatory',
        module: 'geological',
        quantity: 4,
        unit: 'скважин',
        normativeBase: 'СП РК 1.02-102-2014, раздел 9.11',
        description: 'Определение глубины поверхности скольжения',
        priority: 'ОБЯЗАТЕЛЬНЫЙ',
        tags: ['оползни', 'инклинометрия']
      },
      {
        workId: 'landslide-shear-tests',
        name: 'Испытания на срез по поверхностям скольжения',
        category: 'mandatory',
        module: 'geological',
        quantity: 1,
        unit: 'комплекс',
        normativeBase: 'СП РК 1.02-102-2014, раздел 9.11',
        description: 'Определение остаточной прочности',
        priority: 'ОБЯЗАТЕЛЬНЫЙ',
        tags: ['оползни', 'срез', 'лаборатория']
      },
      {
        workId: 'landslide-stability',
        name: 'Расчёты устойчивости склонов',
        category: 'mandatory',
        module: 'geological',
        quantity: 1,
        unit: 'расчёт',
        normativeBase: 'СП РК 1.02-102-2014, раздел 9.11',
        description: 'Определение коэффициента запаса устойчивости',
        priority: 'ОБЯЗАТЕЛЬНЫЙ',
        tags: ['оползни', 'расчёт', 'устойчивость']
      },
      {
        workId: 'landslide-monitoring',
        name: 'Режимные наблюдения за деформациями склона',
        category: 'mandatory',
        module: 'geological',
        quantity: 12,
        unit: 'месяцев',
        normativeBase: 'СП РК 1.02-102-2014, раздел 9.11',
        description: 'Геодезический мониторинг подвижек',
        priority: 'ОБЯЗАТЕЛЬНЫЙ',
        tags: ['оползни', 'мониторинг']
      }
    ];
    
    // Дополнительно для гидроэнергетики
    if (selectedVariant.id === 'variant-hydro-vsn') {
      works.push({
        workId: 'landslide-reservoir',
        name: 'Изучение оползней в бортах водохранилища',
        category: 'mandatory',
        module: 'geological',
        quantity: 1,
        unit: 'комплекс',
        normativeBase: 'ВСН 34.2-88, п. 10.1',
        description: 'Прогноз переработки берегов, волновые подмывы',
        priority: 'СПРАВОЧНЫЙ',
        tags: ['оползни', 'водохранилище']
      });
    }
    
    return works;
  }
};

// ============================================================================
// РАЗДЕЛ 13.3: ПОДТОПЛЕНИЕ
// ============================================================================

/**
 * Блок 13.3: Исследования подтопления территории
 */
export const block_13_03_flooding: InstructionBlock = {
  id: 'block-13-03-flooding-investigation',
  section: 'Раздел 13: Опасные геологические процессы',
  title: 'Исследования подтопления',
  description: 'Режимные наблюдения за УГВ и прогноз подтопления',
  priority: 132,
  tags: ['опасные-процессы', 'подтопление', 'УГВ'],
  
  condition: (input: GeologicalInput) => {
    return (
      input.hazards &&
      input.hazards.some(hazard => {
        const h = hazard.toLowerCase();
        return h.includes('подтоплен') || h.includes('переработка берег');
      })
    );
  },
  
  variants: [
    {
      id: 'variant-mandatory-sp-rk-102',
      priority: 'ОБЯЗАТЕЛЬНЫЙ',
      normative: {
        document: 'СП РК 1.02-102-2014',
        section: 'раздел 9.12',
        priority: 'ОБЯЗАТЕЛЬНЫЙ'
      },
      recommendation: 'Для территорий, подверженных подтоплению, обязательно включить:\n' +
        '**Режимные наблюдения:**\n' +
        '- Режимные наблюдения за уровнем подземных вод (минимум 1 год)\n' +
        '- Сеть наблюдательных скважин\n' +
        '**Изучение источников:**\n' +
        '- Изучение источников подтопления:\n' +
        '  • Инфильтрация атмосферных осадков\n' +
        '  • Утечки из водонесущих коммуникаций\n' +
        '  • Подпор от водохранилищ\n' +
        '  • Барражный эффект фундаментов\n' +
        '**Прогноз:**\n' +
        '- Прогноз изменения гидрогеологических условий после строительства\n' +
        '- Определение зон подтопления\n' +
        '**Расчёты:**\n' +
        '- Гидрогеологические расчёты и численное моделирование\n' +
        '- Расчёт мероприятий по водопонижению',
      recommendedValues: {
        monitoringDuration: {
          value: 12,
          min: 12,
          unit: 'месяцев',
          explanation: 'Минимальная длительность наблюдений'
        }
      }
    }
  ],
  
  generateWorks: (input: GeologicalInput) => {
    return [
      {
        workId: 'flooding-monitoring',
        name: 'Режимные наблюдения за уровнем подземных вод',
        category: 'mandatory',
        module: 'geological',
        quantity: 12,
        unit: 'месяцев',
        normativeBase: 'СП РК 1.02-102-2014, раздел 9.12',
        description: 'Сеть наблюдательных скважин, ежемесячные замеры',
        priority: 'ОБЯЗАТЕЛЬНЫЙ',
        tags: ['подтопление', 'мониторинг', 'УГВ']
      },
      {
        workId: 'flooding-sources',
        name: 'Изучение источников подтопления',
        category: 'mandatory',
        module: 'geological',
        quantity: 1,
        unit: 'комплекс',
        normativeBase: 'СП РК 1.02-102-2014, раздел 9.12',
        description: 'Анализ причин подтопления (инфильтрация, утечки, подпор)',
        priority: 'ОБЯЗАТЕЛЬНЫЙ',
        tags: ['подтопление', 'источники']
      },
      {
        workId: 'flooding-forecast',
        name: 'Прогноз изменения гидрогеологических условий',
        category: 'mandatory',
        module: 'geological',
        quantity: 1,
        unit: 'прогноз',
        normativeBase: 'СП РК 1.02-102-2014, раздел 9.12',
        description: 'Прогноз подтопления после строительства',
        priority: 'ОБЯЗАТЕЛЬНЫЙ',
        tags: ['подтопление', 'прогноз']
      },
      {
        workId: 'flooding-modeling',
        name: 'Гидрогеологическое моделирование',
        category: 'mandatory',
        module: 'geological',
        quantity: 1,
        unit: 'модель',
        normativeBase: 'СП РК 1.02-102-2014, раздел 9.12',
        description: 'Численное моделирование фильтрации, расчёт мероприятий',
        priority: 'ОБЯЗАТЕЛЬНЫЙ',
        tags: ['подтопление', 'моделирование']
      }
    ];
  }
};

// ============================================================================
// РАЗДЕЛ 13.4: СЕЙСМИЧЕСКИЕ ИССЛЕДОВАНИЯ
// ============================================================================

/**
 * Блок 13.4: Сейсмические исследования
 */
export const block_13_04_seismic: InstructionBlock = {
  id: 'block-13-04-seismic-investigations',
  section: 'Раздел 13: Опасные геологические процессы',
  title: 'Сейсмические исследования',
  description: 'Сейсмическое микрорайонирование и динамические характеристики',
  priority: 133,
  tags: ['опасные-процессы', 'сейсмичность', 'землетрясения'],
  
  condition: (input: GeologicalInput) => {
    return (
      input.seismicity !== undefined &&
      input.seismicity >= 6
    );
  },
  
  variants: [
    {
      id: 'variant-mandatory-sp-rk-104',
      priority: 'ОБЯЗАТЕЛЬНЫЙ',
      normative: {
        document: 'СП РК 1.02-104-2014',
        section: 'разделы 5-6',
        priority: 'ОБЯЗАТЕЛЬНЫЙ'
      },
      recommendation: 'Для районов с сейсмичностью ≥ 6 баллов обязательно включить:\n' +
        '**Сейсмическое микрорайонирование (СМР):**\n' +
        '- Детальная оценка сейсмической опасности площадки\n' +
        '- Определение приращения (или уменьшения) балльности относительно фоновой\n' +
        '- Карта сейсмического микрорайонирования\n' +
        '**Динамические характеристики грунтов:**\n' +
        '- Скорости распространения сейсмических волн (Vp, Vs)\n' +
        '- Динамический модуль упругости\n' +
        '- Коэффициент Пуассона\n' +
        '- Декремент колебаний (затухание)\n' +
        '**Оценка разжижения:**\n' +
        '- Оценка возможности разжижения водонасыщенных песчаных грунтов при землетрясениях\n' +
        '**Расчёты:**\n' +
        '- Расчёт сейсмических воздействий на сооружение\n' +
        '- Спектры ускорений для проектирования',
      recommendedValues: {
        seismicity: {
          value: 7, // Исправлено: убрано использование input
          min: 6,
          unit: 'баллов',
          explanation: 'Сейсмичность района'
        },
        methods: {
          value: ['СМР', 'динамика', 'разжижение'],
          unit: 'виды',
          explanation: 'Обязательные исследования'
        }
      },
      warnings: [
        'Обязательно для всех объектов в сейсмоопасных районах',
        'Приращение балльности может достигать ±2 баллов',
        'Разжижение песков - критический фактор при землетрясениях'
      ]
    }
  ],
  
  generateWorks: (input: GeologicalInput) => {
    const seismicity = input.seismicity || 7;
    
    return [
      {
        workId: 'seismic-microzoning',
        name: 'Сейсмическое микрорайонирование (СМР)',
        category: 'mandatory',
        module: 'geological',
        quantity: 1,
        unit: 'комплекс',
        normativeBase: 'СП РК 1.02-104-2014',
        description: `Детальная оценка сейсмической опасности для района ${seismicity} баллов`,
        priority: 'ОБЯЗАТЕЛЬНЫЙ',
        tags: ['сейсмика', 'СМР']
      },
      {
        workId: 'seismic-dynamic-properties',
        name: 'Определение динамических характеристик грунтов',
        category: 'mandatory',
        module: 'geological',
        quantity: 1,
        unit: 'комплекс',
        normativeBase: 'СП РК 1.02-104-2014',
        description: 'Vp, Vs, динамический модуль упругости, декремент',
        priority: 'ОБЯЗАТЕЛЬНЫЙ',
        tags: ['сейсмика', 'динамика']
      },
      {
        workId: 'seismic-liquefaction',
        name: 'Оценка возможности разжижения песчаных грунтов',
        category: 'mandatory',
        module: 'geological',
        quantity: 1,
        unit: 'оценка',
        normativeBase: 'СП РК 1.02-104-2014',
        description: 'Анализ водонасыщенных песков на разжижение при землетрясениях',
        priority: 'ОБЯЗАТЕЛЬНЫЙ',
        tags: ['сейсмика', 'разжижение']
      },
      {
        workId: 'seismic-calculations',
        name: 'Расчёт сейсмических воздействий',
        category: 'mandatory',
        module: 'geological',
        quantity: 1,
        unit: 'расчёт',
        normativeBase: 'СП РК 1.02-104-2014',
        description: 'Спектры ускорений для проектирования сооружения',
        priority: 'ОБЯЗАТЕЛЬНЫЙ',
        tags: ['сейсмика', 'расчёт']
      }
    ];
  }
};

// ============================================================================
// ЭКСПОРТ БЛОКОВ РАЗДЕЛА 13 (файл section10)
// ============================================================================

export const section10Blocks: InstructionBlock[] = [
  block_13_01_karst,       // Карст и суффозия
  block_13_02_landslides,  // Оползни
  block_13_03_flooding,    // Подтопление
  block_13_04_seismic      // Сейсмика
];

export default section10Blocks;
