/**
 * Файл: section19-dynamic-penetration.ts
 * Назначение: Динамическое зондирование грунтов (DPT)
 */

import type { 
  InstructionBlock, 
  GeologicalInput, 
  WorkItem 
} from './types';

/**
 * Блок 19.1: Динамическое зондирование
 */
export const block_19_01_dpt: InstructionBlock = {
  id: 'block-19-01-dynamic-penetration',
  section: 'Раздел 19: Динамическое зондирование',
  title: 'Динамическое зондирование грунтов (DPT)',
  description: 'Определение плотности и прочности ударным методом',
  priority: 31,
  tags: ['полевые', 'зондирование', 'DPT'],
  
  condition: (input: GeologicalInput) => {
    return input.soilTypes?.includes('песчаные') ||
           input.soilTypes?.includes('крупнообломочные') ||
           input.soilTypes?.includes('гравий');
  },
  
  variants: [
    {
      id: 'variant-dpt-standard',
      priority: 'РЕКОМЕНДУЕМЫЙ',
      normative: {
        document: 'ГОСТ 19912-2012',
        section: 'Динамическое зондирование',
        priority: 'РЕКОМЕНДУЕМЫЙ'
      },
      recommendation:
        '**ДИНАМИЧЕСКОЕ ЗОНДИРОВАНИЕ (DPT):**\n\n' +
        
        '**1. СУЩНОСТЬ МЕТОДА:**\n' +
        '- Забивка зонда в грунт ударами\n' +
        '- Подсчёт числа ударов N на 10 см погружения\n' +
        '- Энергия удара: E = M × g × H\n' +
        '- Дискретная запись (через 10 см)\n\n' +
        
        '**2. ТИПЫ ЗОНДОВ:**\n\n' +
        
        '**А. Лёгкое зондирование (DPL):**\n' +
        '- Масса молота: M = 10 кг\n' +
        '- Высота падения: H = 0.5 м\n' +
        '- Энергия удара: E = 50 Дж\n' +
        '- Конус: диаметр 35.7 мм, угол 90°\n' +
        '- Глубина: до 8 м\n' +
        '- Применение: рыхлые пески, супеси\n\n' +
        
        '**Б. Среднее зондирование (DPM):**\n' +
        '- Масса молота: M = 30 кг\n' +
        '- Высота падения: H = 0.5 м\n' +
        '- Энергия удара: E = 150 Дж\n' +
        '- Конус: диаметр 43.7 мм, угол 90°\n' +
        '- Глубина: до 20 м\n' +
        '- Применение: пески, супеси, суглинки\n\n' +
        
        '**В. Тяжёлое зондирование (DPH):**\n' +
        '- Масса молота: M = 63.5 кг\n' +
        '- Высота падения: H = 0.75 м\n' +
        '- Энергия удара: E = 478 Дж\n' +
        '- Конус: диаметр 51 мм, угол 60°\n' +
        '- Глубина: до 30 м\n' +
        '- Применение: плотные пески, гравий, суглинки\n\n' +
        
        '**Г. Сверхтяжёлое (DPSH):**\n' +
        '- Масса молота: M = 63.5 кг\n' +
        '- Высота падения: H = 1.0 м\n' +
        '- Энергия удара: E = 635 Дж\n' +
        '- Применение: очень плотные грунты\n\n' +
        
        '**3. ОПРЕДЕЛЯЕМЫЙ ПАРАМЕТР:**\n\n' +
        
        '**Условное динамическое сопротивление:**\n' +
        '```\n' +
        'pd = (M × g × H) / (A × e)\n' +
        '\n' +
        'где:\n' +
        'M - масса молота, кг\n' +
        'H - высота падения, м\n' +
        'A - площадь конуса, см²\n' +
        'e - осадка от одного удара, см\n' +
        'e = 10 / N₁₀\n' +
        '```\n\n' +
        
        '**Упрощённо:**\n' +
        '```\n' +
        'pd = k × N₁₀    (МПа)\n' +
        '\n' +
        'где k - коэффициент зонда\n' +
        '```\n\n' +
        
        '**4. КОРРЕЛЯЦИИ С ДРУГИМИ ПАРАМЕТРАМИ:**\n\n' +
        
        '**Для песчаных грунтов:**\n' +
        '```\n' +
        'φ = 28° + 15° × log(pd)    (угол трения)\n' +
        'E = 7 × pd                  (модуль деформации, МПа)\n' +
        'ρd = 1.5 + 0.13 × pd       (плотность сухого грунта, г/см³)\n' +
        '```\n\n' +
        
        '**Плотность песков по N₁₀:**\n' +
        '- Рыхлые: N₁₀ < 3\n' +
        '- Средней плотности: 3 ≤ N₁₀ < 10\n' +
        '- Плотные: N₁₀ ≥ 10\n\n' +
        
        '**Для глинистых грунтов:**\n' +
        '```\n' +
        'IL = 1.5 - 0.3 × log(pd)   (показатель консистенции)\n' +
        '```\n\n' +
        
        '**5. ГЛУБИНА ЗОНДИРОВАНИЯ:**\n' +
        '- DPL: до 8 м (рыхлые грунты)\n' +
        '- DPM: до 20 м (типичные грунты)\n' +
        '- DPH: до 30 м (плотные грунты)\n' +
        '- Отказ: при N₁₀ > 50 ударов\n\n' +
        
        '**6. КОЛИЧЕСТВО ТОЧЕК:**\n\n' +
        
        '**Сетка зондирования:**\n' +
        '- I категория: 25×25 м\n' +
        '- II категория: 20×20 м\n' +
        '- III категория: 15×15 м\n\n' +
        
        '**Минимум:** 4-6 точек на объект\n\n' +
        
        '**Для линейных объектов:**\n' +
        '- Через 50-100 м по оси трассы\n' +
        '- + в характерных точках (переходы, пересечения)\n\n' +
        
        '**7. ПРЕИМУЩЕСТВА DPT:**\n' +
        '- Проходимость в гравелистых грунтах\n' +
        '- Простота оборудования\n' +
        '- Низкая стоимость\n' +
        '- Мобильность (переносные установки)\n' +
        '- Проходимость в мёрзлых грунтах (летом)\n\n' +
        
        '**8. НЕДОСТАТКИ:**\n' +
        '- Дискретность (через 10 см)\n' +
        '- Нет трения по муфте\n' +
        '- Зависимость от техники выполнения\n' +
        '- Затруднено в очень плотных грунтах\n\n' +
        
        '**9. ПРИМЕНЕНИЕ:**\n' +
        '- Оценка однородности песчаных оснований\n' +
        '- Контроль уплотнения насыпей\n' +
        '- Определение границ слоёв\n' +
        '- Предварительная разведка (рекогносцировка)\n' +
        '- Дополнение к буровым работам\n\n' +
        
        '**10. СРАВНЕНИЕ С SPT:**\n\n' +
        
        '**SPT (Standard Penetration Test):**\n' +
        '- M = 63.5 кг, H = 0.76 м\n' +
        '- Забивка пробоотборника (внутр. Ø 35 мм)\n' +
        '- Получение образца + число ударов N₃₀\n' +
        '- Применяется в РК редко\n\n' +
        
        '**DPT (Dynamic Probing Test):**\n' +
        '- Различные энергии (50-635 Дж)\n' +
        '- Забивка сплошного конуса\n' +
        '- Только число ударов N₁₀\n' +
        '- Основной метод в РК\n\n' +
        
        '**Корреляция:**\n' +
        '```\n' +
        'N₃₀(SPT) ≈ 0.5 × N₁₀(DPH)\n' +
        '```\n\n' +
        
        '**ВАЖНО:** DPT применяется в основном для песчаных и крупнообломочных грунтов',
      
      recommendedValues: {
        pointsPerHa: {
          value: 2.0,
          unit: 'точек/га',
          explanation: 'Сетка 20×20м (DPM)'
        },
        depthAverage: {
          value: 15,
          unit: 'м',
          explanation: 'Средняя глубина DPM'
        }
      }
    }
  ],
  
  calculateValues: (input: GeologicalInput) => {
    const area = input.buildingArea || 1000;
    const category = input.geotechnicalCategory || 'II';
    
    // Коэффициент по категории
    const kCategory = category === 'I' ? 1.0 : category === 'II' ? 1.5 : 2.0;
    
    // Количество точек (немного меньше чем CPT)
    const points = Math.max(4, Math.ceil((area / 500) * kCategory));
    
    // Глубина
    const depth = 15;
    
    return {
      dptPoints: {
        value: points,
        unit: 'точек',
        explanation: 'Точки динамического зондирования',
        confidence: 80
      },
      averageDepth: {
        value: depth,
        unit: 'м',
        explanation: 'Средняя глубина зондирования',
        confidence: 90
      },
      totalMeters: {
        value: points * depth,
        unit: 'п.м',
        explanation: 'Общий объём зондирования',
        confidence: 80
      }
    };
  },
  
  generateWorks: (input: GeologicalInput) => {
    const works: WorkItem[] = [];
    const values = block_19_01_dpt.calculateValues!(input);
    
    const meters = typeof values.totalMeters.value === 'number'
      ? values.totalMeters.value
      : parseFloat(String(values.totalMeters.value));
    
    works.push({
      workId: 'FIELD-DPT-01',
      name: 'Динамическое зондирование грунтов (DPT)',
      description: 
        'Зондирование методом DPM (M=30кг, H=0.5м). Определение числа ударов N₁₀, ' +
        'расчёт условного динамического сопротивления pd',
      unit: 'п.м',
      quantity: meters,
      category: 'recommended',
      module: 'geological',
      priority: 'РЕКОМЕНДУЕМЫЙ',
      normativeBase: 'ГОСТ 19912-2012',
      tags: ['полевые', 'зондирование'],
      priceTableCode: '1602-0406'
    });
    
    return works;
  }
};

export const section19_blocks: InstructionBlock[] = [
  block_19_01_dpt
];

export default section19_blocks;
