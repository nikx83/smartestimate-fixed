/**
 * Файл: section34-rock-soils.ts
 * Назначение: Лабораторные испытания скальных грунтов
 */

import type { 
  InstructionBlock, 
  GeologicalInput, 
  WorkItem 
} from './types';

/**
 * Блок 34.1: Испытания скальных грунтов
 */
export const block_34_01_rock_soils: InstructionBlock = {
  id: 'block-34-01-rock-soils',
  section: 'Раздел 34: Скальные грунты',
  title: 'Лабораторные испытания скальных и полускальных грунтов',
  description: 'Определение прочностных и деформационных свойств скальных пород',
  priority: 49,
  tags: ['лабораторные', 'скальные', 'прочность', 'деформация'],
  
  condition: (input: GeologicalInput) => {
    return input.soilTypes?.includes('скальные') ||
           input.soilTypes?.includes('полускальные');
  },
  
  variants: [
    {
      id: 'variant-rock-standard',
      priority: 'ОБЯЗАТЕЛЬНЫЙ',
      normative: {
        document: 'ГОСТ 21153.2-84',
        section: 'Породы горные. Методы определения предела прочности',
        priority: 'ОБЯЗАТЕЛЬНЫЙ'
      },
      recommendation:
        '**ЛАБОРАТОРНЫЕ ИСПЫТАНИЯ СКАЛЬНЫХ ГРУНТОВ:**\n\n' +
        
        '**1. КЛАССИФИКАЦИЯ СКАЛЬНЫХ ГРУНТОВ:**\n\n' +
        
        '**По прочности (предел прочности на сжатие Rc):**\n' +
        '- Очень прочные: Rc > 120 МПа (граниты, кварциты)\n' +
        '- Прочные: 50 < Rc ≤ 120 МПа (песчаники, известняки)\n' +
        '- Средней прочности: 15 < Rc ≤ 50 МПа (мергели, аргиллиты)\n' +
        '- Малопрочные: 5 < Rc ≤ 15 МПа (алевролиты, глинистые сланцы)\n' +
        '- Пониженной прочности: 3 < Rc ≤ 5 МПа (мел, туф)\n' +
        '- Низкой прочности: 1 < Rc ≤ 3 МПа (выветрелые породы)\n\n' +
        
        '**По степени выветрелости:**\n' +
        '- Невыветрелые: сохраняют первичную структуру\n' +
        '- Слабовыветрелые: частичное изменение минералов\n' +
        '- Выветрелые: значительное изменение, снижение прочности >25%\n' +
        '- Сильновыветрелые: переход в дресвяно-щебенистый грунт\n\n' +
        
        '**2. ОБЯЗАТЕЛЬНЫЕ ИСПЫТАНИЯ:**\n\n' +
        
        '**А. Предел прочности на одноосное сжатие (Rc):**\n' +
        '- Образцы: цилиндры или кубы\n' +
        '- Размер: d=42-54 мм, h=2d (цилиндр)\n' +
        '- Или: 50×50×50 мм (куб)\n' +
        '- Подготовка: алмазное сверление/выпиливание\n' +
        '- Торцы: шлифовка, параллельность <0.05 мм\n' +
        '- Скорость нагружения: 0.5-1.0 МПа/с\n' +
        '- До разрушения\n\n' +
        
        '**Формула:**\n' +
        '```\n' +
        'Rc = Pmax / A\n' +
        '\n' +
        'где:\n' +
        'Pmax - разрушающая нагрузка, Н\n' +
        'A - площадь поперечного сечения, мм²\n' +
        '\n' +
        'Пример: образец d=50мм, Pmax=300кН\n' +
        'A = π × 25² = 1963 мм²\n' +
        'Rc = 300000 / 1963 = 153 МПа (очень прочная порода)\n' +
        '```\n\n' +
        
        '**Б. Плотность породы (ρ):**\n' +
        '- Метод: гидростатическое взвешивание\n' +
        '- Образец в воде и на воздухе\n' +
        '- ρ = M / (M - Mводе), г/см³\n' +
        '- Типичные значения: 2.5-3.0 г/см³\n\n' +
        
        '**В. Влажность (W):**\n' +
        '- Высушивание при 105-110°C\n' +
        '- До постоянной массы\n' +
        '- Для скальных: обычно W < 5%\n\n' +
        
        '**Г. Пористость (n) и трещиноватость:**\n' +
        '```\n' +
        'n = (1 - ρ/ρs) × 100%\n' +
        '\n' +
        'где:\n' +
        'ρ - плотность породы\n' +
        'ρs - плотность минералов (~2.70 г/см³)\n' +
        '```\n\n' +
        
        '**3. ДОПОЛНИТЕЛЬНЫЕ ИСПЫТАНИЯ:**\n\n' +
        
        '**А. Прочность на растяжение (Rt):**\n' +
        '- Метод: раскалывание диска (бразильская проба)\n' +
        '- Образец: диск d=54 мм, h=27 мм\n' +
        '- Сжатие по диаметру до раскола\n' +
        '```\n' +
        'Rt = 2P / (π × d × h)\n' +
        '\n' +
        'Типично: Rt ≈ (0.05-0.15) × Rc\n' +
        '```\n\n' +
        
        '**Б. Модуль деформации (E):**\n' +
        '- При одноосном сжатии с приборами\n' +
        '- Измерение продольной и поперечной деформации\n' +
        '- E = σ / ε (в упругой зоне)\n' +
        '- Типичные значения:\n' +
        '  * Граниты: E = 40-70 ГПа\n' +
        '  * Песчаники: E = 10-30 ГПа\n' +
        '  * Известняки: E = 15-40 ГПа\n' +
        '  * Мергели: E = 5-15 ГПа\n\n' +
        
        '**В. Коэффициент Пуассона (ν):**\n' +
        '```\n' +
        'ν = εпопереч / εпродоль\n' +
        '\n' +
        'Типично: ν = 0.15-0.30 для скальных\n' +
        '```\n\n' +
        
        '**Г. Водопоглощение:**\n' +
        '- Погружение в воду на 48 часов\n' +
        '- Wв = (Mнасыщ - Mсух) / Mсух × 100%\n' +
        '- Для скальных: обычно <3%\n\n' +
        
        '**4. СПЕЦИАЛЬНЫЕ ИСПЫТАНИЯ:**\n\n' +
        
        '**А. Трёхосное сжатие:**\n' +
        '- Стабилометр высокого давления\n' +
        '- Боковое обжатие σ3 = 5-20 МПа\n' +
        '- Определение:\n' +
        '  * Угла внутреннего трения φ\n' +
        '  * Сцепления c\n' +
        '  * Критерий Мора-Кулона\n\n' +
        
        '**Б. Размокаемость:**\n' +
        '- Для глинистых сланцев, аргиллитов, алевролитов\n' +
        '- Погружение в воду\n' +
        '- Наблюдение за распадом\n' +
        '- Классификация:\n' +
        '  * Неразмокаемые: сохраняют форму >24 часа\n' +
        '  * Размокаемые: распад <24 часа\n\n' +
        
        '**В. Морозостойкость:**\n' +
        '- Циклы замораживание-оттаивание: 15-25\n' +
        '- Потеря массы и прочности\n' +
        '- Важно для дорожных материалов\n\n' +
        
        '**Г. Истираемость:**\n' +
        '- Во вращающемся барабане\n' +
        '- Потеря массы после 5000 оборотов\n\n' +
        
        '**5. КОЛИЧЕСТВО ОБРАЗЦОВ:**\n' +
        '- Rc (сжатие): 5-6 образцов на ИГЭ\n' +
        '- Плотность: 3-5 определений\n' +
        '- Модуль E: 3-5 образцов\n' +
        '- Остальные: 2-3 определения\n\n' +
        
        '**6. ПОДГОТОВКА ОБРАЗЦОВ:**\n' +
        '- Керн из скважин: диаметр 76-132 мм\n' +
        '- Отбор монолитов из обнажений/шурфов\n' +
        '- Алмазное сверление цилиндров из керна\n' +
        '- Шлифовка торцов\n' +
        '- Контроль параллельности и перпендикулярности\n\n' +
        
        '**7. ТИПИЧНЫЕ ХАРАКТЕРИСТИКИ:**\n\n' +
        
        '**Магматические:**\n' +
        '- Граниты: Rc=100-250 МПа, E=40-70 ГПа, ρ=2.6-2.8\n' +
        '- Базальты: Rc=150-350 МПа, E=50-90 ГПа, ρ=2.8-3.1\n\n' +
        
        '**Осадочные:**\n' +
        '- Песчаники: Rc=30-120 МПа, E=10-30 ГПа, ρ=2.2-2.6\n' +
        '- Известняки: Rc=40-150 МПа, E=15-40 ГПа, ρ=2.4-2.8\n' +
        '- Мергели: Rc=10-40 МПа, E=5-15 ГПа, ρ=2.0-2.5\n' +
        '- Аргиллиты: Rc=15-60 МПа, E=8-20 ГПа, ρ=2.2-2.6\n\n' +
        
        '**Метаморфические:**\n' +
        '- Кварциты: Rc=150-300 МПа, E=50-80 ГПа, ρ=2.6-2.8\n' +
        '- Сланцы: Rc=20-80 МПа, E=10-25 ГПа, ρ=2.5-2.8\n\n' +
        
        '**8. ВЛИЯНИЕ ВЫВЕТРИВАНИЯ:**\n' +
        '- Слабовыветрелые: Rc снижается на 10-25%\n' +
        '- Выветрелые: Rc снижается на 25-50%\n' +
        '- Сильновыветрелые: Rc снижается >50%\n\n' +
        
        '**9. ПРИМЕНЕНИЕ РЕЗУЛЬТАТОВ:**\n' +
        '- Расчёт несущей способности скальных оснований\n' +
        '- Проектирование фундаментов на скале\n' +
        '- Оценка устойчивости скальных склонов\n' +
        '- Взрываемость пород\n' +
        '- Оценка пригодности как строительного материала\n\n' +
        
        '**ВАЖНО:** Скальные грунты требуют специального керноотборного бурения',
      
      recommendedValues: {
        samplesCompression: {
          value: 5,
          unit: 'образцов',
          explanation: 'На сжатие (Rc)'
        },
        samplesDensity: {
          value: 3,
          unit: 'определений',
          explanation: 'Плотность породы'
        }
      }
    }
  ],
  
  calculateValues: (input: GeologicalInput) => {
    const ige = input.expectedIGE || 2;
    
    // Количество испытаний
    const compression = ige * 5;  // Rc
    const density = ige * 3;       // ρ
    const modulus = ige * 3;       // E
    const tensile = ige * 2;       // Rt
    
    const total = compression + density + modulus + tensile;
    
    return {
      rockCompression: {
        value: compression,
        unit: 'образцов',
        explanation: 'Одноосное сжатие (Rc)',
        confidence: 90
      },
      rockDensity: {
        value: density,
        unit: 'определений',
        explanation: 'Плотность породы',
        confidence: 90
      },
      rockModulus: {
        value: modulus,
        unit: 'образцов',
        explanation: 'Модуль деформации (E)',
        confidence: 85
      },
      rockTensile: {
        value: tensile,
        unit: 'образцов',
        explanation: 'Прочность на растяжение (Rt)',
        confidence: 80
      },
      totalRockTests: {
        value: total,
        unit: 'испытаний',
        explanation: 'Всего испытаний скальных грунтов',
        confidence: 90
      }
    };
  },
  
  generateWorks: (input: GeologicalInput) => {
    const works: WorkItem[] = [];
    const values = block_34_01_rock_soils.calculateValues!(input);
    
    const qtyCompression = typeof values.rockCompression.value === 'number'
      ? values.rockCompression.value
      : parseInt(String(values.rockCompression.value));
    
    const qtyDensity = typeof values.rockDensity.value === 'number'
      ? values.rockDensity.value
      : parseInt(String(values.rockDensity.value));
    
    const qtyModulus = typeof values.rockModulus.value === 'number'
      ? values.rockModulus.value
      : parseInt(String(values.rockModulus.value));
    
    works.push({
      workId: 'LAB-ROCK-01',
      name: 'Одноосное сжатие скальных грунтов',
      description: 
        'Испытание цилиндрических образцов на одноосное сжатие. ' +
        'Определение предела прочности Rc',
      unit: 'образец',
      quantity: qtyCompression,
      category: 'mandatory',
      module: 'geological',
      priority: 'ОБЯЗАТЕЛЬНЫЙ',
      normativeBase: 'ГОСТ 21153.2-84',
      tags: ['лабораторные', 'скальные', 'прочность'],
      priceTableCode: '1602-0714'
    });
    
    works.push({
      workId: 'LAB-ROCK-02',
      name: 'Плотность скальных пород',
      description: 
        'Определение плотности гидростатическим взвешиванием',
      unit: 'определение',
      quantity: qtyDensity,
      category: 'mandatory',
      module: 'geological',
      priority: 'ОБЯЗАТЕЛЬНЫЙ',
      normativeBase: 'ГОСТ 21153.2-84',
      tags: ['лабораторные', 'плотность'],
      priceTableCode: '1602-0715'
    });
    
    works.push({
      workId: 'LAB-ROCK-03',
      name: 'Модуль деформации скальных грунтов',
      description: 
        'Определение модуля деформации E при одноосном сжатии с приборами',
      unit: 'образец',
      quantity: qtyModulus,
      category: 'recommended',
      module: 'geological',
      priority: 'РЕКОМЕНДУЕМЫЙ',
      normativeBase: 'ГОСТ 28985-91',
      tags: ['лабораторные', 'модуль'],
      priceTableCode: '1602-0716'
    });
    
    return works;
  }
};

export const section34_blocks: InstructionBlock[] = [
  block_34_01_rock_soils
];

export default section34_blocks;
