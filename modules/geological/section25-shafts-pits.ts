/**
 * Файл: section25-shafts-pits.ts
 * Назначение: Проходка шурфов и закопушек
 */

import type { 
  InstructionBlock, 
  GeologicalInput, 
  WorkItem 
} from './types';

/**
 * Блок 25.1: Закопушки
 */
export const block_25_01_test_pits: InstructionBlock = {
  id: 'block-25-01-test-pits',
  section: 'Раздел 25: Шурфы и закопушки',
  title: 'Проходка закопушек',
  description: 'Мелкие выработки глубиной до 1.5 м для отбора образцов',
  priority: 41,
  tags: ['горные-работы', 'закопушки', 'отбор-образцов'],
  
  condition: (input: GeologicalInput) => {
    return input.requiresSoilSampling === true ||
           input.geotechnicalCategory !== 'I';
  },
  
  variants: [
    {
      id: 'variant-test-pits',
      priority: 'РЕКОМЕНДУЕМЫЙ',
      normative: {
        document: 'СП РК 1.02-102-2014',
        section: 'Горнопроходческие работы',
        priority: 'РЕКОМЕНДУЕМЫЙ'
      },
      recommendation:
        '**ПРОХОДКА ЗАКОПУШЕК:**\n\n' +
        
        '**1. НАЗНАЧЕНИЕ:**\n' +
        '- Отбор образцов из верхних слоёв (0-1.5 м)\n' +
        '- Предварительная оценка грунтов\n' +
        '- Изучение почвенного покрова\n' +
        '- Линейные изыскания (трассы дорог, трубопроводов)\n' +
        '- Рекогносцировочные работы\n\n' +
        
        '**2. РАЗМЕРЫ:**\n' +
        '- Размеры в плане: 0.7×0.7 м или 1.0×1.0 м\n' +
        '- Глубина: 0.5-1.5 м (обычно 1.0 м)\n' +
        '- Форма: прямоугольная или квадратная\n\n' +
        
        '**3. МЕТОДИКА ПРОХОДКИ:**\n' +
        '- Ручная копка (лопата, кирка)\n' +
        '- Послойное снятие грунта (по 0.2-0.3 м)\n' +
        '- Зачистка стенок и дна\n' +
        '- Описание грунтов по стенкам\n' +
        '- Отбор образцов ненарушенного сложения\n' +
        '- Фотофиксация\n' +
        '- Засыпка после завершения\n\n' +
        
        '**4. ПРОИЗВОДИТЕЛЬНОСТЬ:**\n' +
        '- В супесях, суглинках: 4-6 закопушек/день\n' +
        '- В глинах: 3-4 закопушек/день\n' +
        '- В песках: 5-8 закопушек/день\n' +
        '- В гравелистых грунтах: 2-3 закопушек/день\n\n' +
        
        '**5. КОЛИЧЕСТВО:**\n\n' +
        
        '**Для площадных объектов:**\n' +
        '- Сетка: 50×50 м или 100×100 м\n' +
        '- Минимум: 3-5 закопушек\n\n' +
        
        '**Для линейных объектов:**\n' +
        '- Через 100-200 м по оси трассы\n' +
        '- + в характерных точках (переходы, пересечения)\n\n' +
        
        '**6. ОТБОР ОБРАЗЦОВ:**\n' +
        '- Ненарушенной структуры: в кольца, монолиты\n' +
        '- Нарушенной структуры: в мешки (2-5 кг)\n' +
        '- С каждого слоя (через 0.3-0.5 м)\n' +
        '- Минимум 2 образца из закопушки\n\n' +
        
        '**7. ДОКУМЕНТАЦИЯ:**\n' +
        '- План расположения\n' +
        '- Зарисовка стенки (литологический разрез)\n' +
        '- Описание грунтов\n' +
        '- Отметки отбора образцов\n' +
        '- Фото\n\n' +
        
        '**8. ПРЕИМУЩЕСТВА:**\n' +
        '- Простота и быстрота\n' +
        '- Низкая стоимость\n' +
        '- Визуальный контроль грунтов\n' +
        '- Возможность отбора монолитов\n' +
        '- Не требует оборудования\n\n' +
        
        '**9. ОГРАНИЧЕНИЯ:**\n' +
        '- Малая глубина (до 1.5 м)\n' +
        '- Затруднена при высоком УГВ\n' +
        '- Невозможна зимой в мёрзлых грунтах\n' +
        '- Трудоёмка в скальных грунтах\n\n' +
        
        '**10. ТЕХНИКА БЕЗОПАСНОСТИ:**\n' +
        '- Крепление при глубине >1.2 м в слабых грунтах\n' +
        '- Ограждение открытых выработок\n' +
        '- Засыпка после завершения работ\n\n' +
        
        '**ПРИМЕНЕНИЕ:** Предварительные и линейные изыскания',
      
      recommendedValues: {
        depth: {
          value: 1.0,
          unit: 'м',
          explanation: 'Типичная глубина'
        },
        productivity: {
          value: 5,
          unit: 'закопушек/день',
          explanation: 'В средних условиях'
        }
      }
    }
  ],
  
  calculateValues: (input: GeologicalInput) => {
    const area = input.buildingArea || 0;
    const linear = input.linearLength || 0;
    
    let testPitsCount = 0;
    
    if (area > 0) {
      // Площадной объект - сетка 50×50м
      testPitsCount = Math.max(3, Math.ceil(area / 2500));
    } else if (linear > 0) {
      // Линейный объект - через 150м
      testPitsCount = Math.ceil(linear / 150);
    } else {
      testPitsCount = 3; // минимум
    }
    
    return {
      testPits: {
        value: testPitsCount,
        unit: 'закопушек',
        explanation: 'Количество закопушек',
        confidence: 85
      },
      totalVolume: {
        value: testPitsCount * 0.7, // 0.7 м³ на закопушку (0.7×0.7×1.0)
        unit: 'м³',
        explanation: 'Общий объём выемки',
        confidence: 85
      }
    };
  },
  
  generateWorks: (input: GeologicalInput) => {
    const works: WorkItem[] = [];
    const values = block_25_01_test_pits.calculateValues!(input);
    
    const qty = typeof values.testPits.value === 'number'
      ? values.testPits.value
      : parseInt(String(values.testPits.value));
    
    if (qty > 0) {
      works.push({
        workId: 'MINING-PIT-01',
        name: 'Проходка закопушек',
        description: 
          'Ручная копка закопушек 0.7×0.7 м, глубина 1.0 м. ' +
          'Послойное описание грунтов, отбор образцов, засыпка',
        unit: 'закопушка',
        quantity: qty,
        category: 'recommended',
        module: 'geological',
        priority: 'РЕКОМЕНДУЕМЫЙ',
        normativeBase: 'СП РК 1.02-102-2014',
        tags: ['горные-работы', 'закопушки'],
        priceTableCode: '1602-0301-01'
      });
    }
    
    return works;
  }
};

/**
 * Блок 25.2: Шурфы
 */
export const block_25_02_shafts: InstructionBlock = {
  id: 'block-25-02-shafts',
  section: 'Раздел 25: Шурфы и закопушки',
  title: 'Проходка шурфов',
  description: 'Вертикальные горные выработки глубиной более 1.5 м',
  priority: 42,
  tags: ['горные-работы', 'шурфы', 'глубокие-выработки'],
  
  condition: (input: GeologicalInput) => {
    return input.requiresShafts === true ||
           input.geotechnicalCategory === 'III' ||
           (input.numberOfFloors && input.numberOfFloors >= 10);
  },
  
  variants: [
    {
      id: 'variant-shafts',
      priority: 'ОБЯЗАТЕЛЬНЫЙ',
      normative: {
        document: 'ГОСТ 20276-2012',
        section: 'Горные выработки',
        priority: 'ОБЯЗАТЕЛЬНЫЙ'
      },
      recommendation:
        '**ПРОХОДКА ШУРФОВ:**\n\n' +
        
        '**1. НАЗНАЧЕНИЕ:**\n' +
        '- Отбор образцов ненарушенного сложения с глубины >1.5 м\n' +
        '- Визуальный контроль грунтов по всей глубине\n' +
        '- Полевые испытания в шурфе (штампы, срез)\n' +
        '- Изучение грунтов под фундаментами\n' +
        '- Детальное описание разреза\n' +
        '- Фотофиксация стенок\n\n' +
        
        '**2. РАЗМЕРЫ:**\n' +
        '- Размеры в плане:\n' +
        '  * До 3 м: 1.0×1.5 м или 1.5×1.5 м\n' +
        '  * 3-6 м: 1.5×2.0 м\n' +
        '  * >6 м: 2.0×2.0 м (с креплением)\n' +
        '- Глубина: 1.5-10 м (обычно 3-5 м)\n' +
        '- Форма: прямоугольная\n\n' +
        
        '**3. МЕТОДИКА ПРОХОДКИ:**\n\n' +
        
        '**Ручная проходка (до 5-6 м):**\n' +
        '- Послойная выемка грунта (по 0.5 м)\n' +
        '- Зачистка стенок после каждого слоя\n' +
        '- Установка креплений при необходимости\n' +
        '- Подъём грунта ведром на треноге\n' +
        '- Спуск/подъём людей по лестнице\n\n' +
        
        '**Механизированная проходка (>5 м):**\n' +
        '- Экскаватор с узким ковшом\n' +
        '- Ручная зачистка стенок\n' +
        '- Обязательное крепление\n\n' +
        
        '**4. КРЕПЛЕНИЕ ШУРФОВ:**\n\n' +
        
        '**Когда требуется:**\n' +
        '- Глубина >2 м в рыхлых песках\n' +
        '- Глубина >3 м в пластичных глинах\n' +
        '- Глубина >5 м в любых грунтах\n' +
        '- При обводнённости\n' +
        '- При нависающих стенках\n\n' +
        
        '**Типы крепления:**\n' +
        '- Сплошное: доски 40-50 мм + стойки + распорки\n' +
        '- Разреженное: через 0.5-1.0 м (в плотных грунтах)\n' +
        '- Инвентарное: металлические рамы\n\n' +
        
        '**5. ПРОИЗВОДИТЕЛЬНОСТЬ:**\n' +
        '```\n' +
        'Глубина 3 м: 1 шурф за 2-3 дня (вручную)\n' +
        'Глубина 5 м: 1 шурф за 4-5 дней (вручную + крепление)\n' +
        'Глубина 8 м: 1 шурф за 6-8 дней (механизировано + крепление)\n' +
        '```\n\n' +
        
        '**6. ОБЪЁМ ВЫЕМКИ:**\n' +
        '```\n' +
        'V = S × h\n' +
        '\n' +
        'Для шурфа 1.5×1.5×3 м: V = 6.75 м³\n' +
        'Для шурфа 2.0×2.0×5 м: V = 20 м³\n' +
        '```\n\n' +
        
        '**7. КОЛИЧЕСТВО ШУРФОВ:**\n\n' +
        
        '**По категории объекта:**\n' +
        '- I категория: 1-2 шурфа\n' +
        '- II категория: 2-3 шурфа\n' +
        '- III категория: 3-5 шурфов\n\n' +
        
        '**По назначению:**\n' +
        '- Для штамповых испытаний: 2-3 шурфа\n' +
        '- Для отбора монолитов: 1-2 шурфа на ИГЭ\n' +
        '- Для детального описания: 1 шурф на характерный участок\n\n' +
        
        '**8. ОТБОР ОБРАЗЦОВ:**\n' +
        '- Ненарушенного сложения: каждые 0.5 м по глубине\n' +
        '- Монолиты крупные: для штамповых испытаний\n' +
        '- Нарушенного сложения: с каждого слоя\n' +
        '- Минимум 5-8 образцов из шурфа глубиной 3 м\n\n' +
        
        '**9. ДОКУМЕНТАЦИЯ:**\n' +
        '- План и разрез шурфа\n' +
        '- Детальное литологическое описание стенок\n' +
        '- Зарисовка всех 4 стенок\n' +
        '- Фотографии стенок и дна\n' +
        '- Отметки отбора образцов\n' +
        '- Акт ликвидации\n\n' +
        
        '**10. ВОДООТЛИВ:**\n' +
        '- При вскрытии УГВ - насос\n' +
        '- Производительность: 5-10 м³/час\n' +
        '- Непрерывная откачка при проходке\n' +
        '- Дренажная канавка вокруг шурфа\n\n' +
        
        '**11. ТЕХНИКА БЕЗОПАСНОСТИ:**\n\n' +
        
        '**КРИТИЧНО:**\n' +
        '- Крепление обязательно при глубине >3 м\n' +
        '- Ограждение устья шурфа\n' +
        '- Запрет спуска без лестницы\n' +
        '- Проверка загазованности перед спуском (глубина >5 м)\n' +
        '- Страховочный пояс при работе на дне\n' +
        '- Запрет работы одного человека в шурфе\n' +
        '- Ликвидация шурфов после завершения:\n' +
        '  * Засыпка с послойным уплотнением\n' +
        '  * Снятие креплений\n' +
        '  * Планировка поверхности\n\n' +
        
        '**12. ПРЕИМУЩЕСТВА:**\n' +
        '- Визуальный контроль грунтов\n' +
        '- Отбор образцов высокого качества\n' +
        '- Возможность полевых испытаний\n' +
        '- Детальное описание разреза\n' +
        '- Фотодокументация\n\n' +
        
        '**13. НЕДОСТАТКИ:**\n' +
        '- Высокая трудоёмкость\n' +
        '- Опасность обрушения\n' +
        '- Затруднена при УГВ <2 м\n' +
        '- Невозможна зимой без оттаивания\n\n' +
        
        '**ВАЖНО:** Шурфы - обязательны для III категории и высотных зданий',
      
      recommendedValues: {
        depth: {
          value: 3,
          unit: 'м',
          explanation: 'Типичная глубина'
        },
        crossSection: {
          value: 1.5,
          unit: 'м',
          explanation: 'Размер в плане'
        }
      }
    }
  ],
  
  calculateValues: (input: GeologicalInput) => {
    const category = input.geotechnicalCategory || 'II';
    
    // Количество шурфов по категории
    let shaftsCount = 0;
    if (category === 'I') {
      shaftsCount = 1;
    } else if (category === 'II') {
      shaftsCount = 2;
    } else { // III
      shaftsCount = 4;
    }
    
    // Типичная глубина
    const avgDepth = input.foundationDepth ? 
                     Math.min(input.foundationDepth + 2, 6) : 3;
    
    // Объём выемки (1.5×1.5×h)
    const volumePerShaft = 1.5 * 1.5 * avgDepth;
    const totalVolume = shaftsCount * volumePerShaft;
    
    return {
      shafts: {
        value: shaftsCount,
        unit: 'шурфов',
        explanation: 'Количество шурфов',
        confidence: 90
      },
      averageDepth: {
        value: avgDepth,
        unit: 'м',
        explanation: 'Средняя глубина шурфов',
        confidence: 85
      },
      totalVolume: {
        value: totalVolume,
        unit: 'м³',
        explanation: 'Общий объём выемки',
        confidence: 85
      }
    };
  },
  
  generateWorks: (input: GeologicalInput) => {
    const works: WorkItem[] = [];
    const values = block_25_02_shafts.calculateValues!(input);
    
    const qtyShafts = typeof values.shafts.value === 'number'
      ? values.shafts.value
      : parseInt(String(values.shafts.value));
    
    const volume = typeof values.totalVolume.value === 'number'
      ? values.totalVolume.value
      : parseFloat(String(values.totalVolume.value));
    
    if (qtyShafts > 0) {
      works.push({
        workId: 'MINING-SHAFT-01',
        name: 'Проходка шурфов',
        description: 
          'Ручная проходка шурфов 1.5×1.5 м. Послойная выемка, ' +
          'зачистка стенок, крепление при необходимости, отбор образцов',
        unit: 'м³',
        quantity: volume,
        category: 'mandatory',
        module: 'geological',
        priority: 'ОБЯЗАТЕЛЬНЫЙ',
        normativeBase: 'ГОСТ 20276-2012',
        tags: ['горные-работы', 'шурфы'],
        priceTableCode: '1602-0302-01'
      });
    }
    
    return works;
  }
};

export const section25_blocks: InstructionBlock[] = [
  block_25_01_test_pits,
  block_25_02_shafts
];

export default section25_blocks;
