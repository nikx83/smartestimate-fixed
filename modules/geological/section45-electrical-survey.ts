/**
 * Файл: section45-electrical-survey.ts
 * Назначение: Электроразведочные работы
 */

import type { 
  InstructionBlock, 
  GeologicalInput, 
  WorkItem 
} from './types';

/**
 * Блок 45.1: Вертикальное электрическое зондирование (ВЭЗ)
 */
export const block_45_01_ves: InstructionBlock = {
  id: 'block-45-01-ves',
  section: 'Раздел 45: Электроразведка',
  title: 'Вертикальное электрическое зондирование (ВЭЗ)',
  description: 'Определение глубин залегания слоёв по удельному сопротивлению',
  priority: 33,
  tags: ['геофизика', 'электроразведка', 'ВЭЗ'],
  
  condition: (input: GeologicalInput) => {
    return input.requiresGeophysics === true ||
           input.hasGroundwater === true ||
           input.buildingArea > 3000;
  },
  
  variants: [
    {
      id: 'variant-ves-standard',
      priority: 'РЕКОМЕНДУЕМЫЙ',
      normative: {
        document: 'СП РК 1.02-102-2014',
        section: 'Геофизические методы',
        priority: 'РЕКОМЕНДУЕМЫЙ'
      },
      recommendation:
        '**ВЕРТИКАЛЬНОЕ ЭЛЕКТРИЧЕСКОЕ ЗОНДИРОВАНИЕ (ВЭЗ):**\n\n' +
        
        '**1. ФИЗИЧЕСКИЕ ОСНОВЫ:**\n' +
        '- Измерение кажущегося удельного сопротивления ρk\n' +
        '- Постепенное увеличение разноса электродов\n' +
        '- Глубинность ≈ половина разноса AB/2\n' +
        '- Построение кривых ВЭЗ: ρk = f(AB/2)\n\n' +
        
        '**2. УСТАНОВКИ ЭЛЕКТРОДОВ:**\n\n' +
        
        '**А. Четырёхэлектродная установка Шлюмберже:**\n' +
        '```\n' +
        'A -------- M -- N -------- B\n' +
        '|<-- AB/2 -->|<-MN->|<-- AB/2 -->|\n' +
        '\n' +
        'Условие: AB >> MN (обычно AB = 5-10 × MN)\n' +
        '```\n\n' +
        
        '**Расчёт кажущегося сопротивления:**\n' +
        '```\n' +
        'ρk = K × (ΔU / I)\n' +
        '\n' +
        'где:\n' +
        'K - коэффициент установки\n' +
        'K = π × (AB/2)² / MN  (для установки Шлюмберже)\n' +
        'ΔU - разность потенциалов между M и N, мВ\n' +
        'I - сила тока между A и B, мА\n' +
        '```\n\n' +
        
        '**Б. Установка Веннера:**\n' +
        '```\n' +
        'A ---- M ---- N ---- B\n' +
        '|<-a->|<-a->|<-a->|\n' +
        '\n' +
        'ρk = 2π × a × (ΔU / I)\n' +
        '```\n\n' +
        
        '**3. МЕТОДИКА ПОЛЕВЫХ РАБОТ:**\n\n' +
        
        '**Последовательность разносов AB/2 (Шлюмберже):**\n' +
        '- 1.5, 2, 3, 4, 6, 8, 10, 15, 20, 30, 40, 60, 80, 100, 150, 200 м\n' +
        '- При каждом разносе: 3-5 измерений\n' +
        '- Продолжительность: 1-2 часа на точку\n\n' +
        
        '**Расстановка MN:**\n' +
        '- MN = 1 м при AB/2 < 10 м\n' +
        '- MN = 10 м при AB/2 = 10-100 м\n' +
        '- MN = 20 м при AB/2 > 100 м\n\n' +
        
        '**4. ОБРАБОТКА ДАННЫХ:**\n\n' +
        
        '**А. Построение кривой ВЭЗ:**\n' +
        '- График lg(ρk) vs lg(AB/2)\n' +
        '- Билогарифмический масштаб\n' +
        '- Сглаживание аномальных точек\n\n' +
        
        '**Б. Интерпретация:**\n' +
        '- Качественная: по форме кривой (тип кривой)\n' +
        '- Количественная: подбор параметров слоёв\n' +
        '- Программы: IPI2Win, ZondRes2D, Res2DInv\n\n' +
        
        '**Типы кривых ВЭЗ:**\n' +
        '- H-тип: ρ₁ > ρ₂ < ρ₃ (проводящий слой в середине)\n' +
        '- K-тип: ρ₁ < ρ₂ > ρ₃ (резистивный слой)\n' +
        '- A-тип: ρ₁ < ρ₂ < ρ₃ (возрастание)\n' +
        '- Q-тип: ρ₁ > ρ₂ > ρ₃ (убывание)\n\n' +
        
        '**5. ТИПИЧНЫЕ УДЕЛЬНЫЕ СОПРОТИВЛЕНИЯ:**\n\n' +
        
        '**Рыхлые грунты:**\n' +
        '- Глины влажные: 5-30 Ом·м\n' +
        '- Суглинки: 20-100 Ом·м\n' +
        '- Супеси: 50-200 Ом·м\n' +
        '- Пески влажные: 100-300 Ом·м\n' +
        '- Пески сухие: 500-2000 Ом·м\n' +
        '- Гравий, галька: 300-1000 Ом·м\n\n' +
        
        '**Подземные воды:**\n' +
        '- Пресные: 10-100 Ом·м\n' +
        '- Минерализованные: 0.5-10 Ом·м\n' +
        '- Рассолы: 0.1-1 Ом·м\n\n' +
        
        '**Скальные грунты:**\n' +
        '- Известняки: 500-10000 Ом·м\n' +
        '- Песчаники: 100-1000 Ом·м\n' +
        '- Граниты сухие: 5000-100000 Ом·м\n' +
        '- Граниты трещиноватые: 500-5000 Ом·м\n\n' +
        
        '**6. ГЛУБИННОСТЬ ИССЛЕДОВАНИЙ:**\n' +
        '```\n' +
        'hmax ≈ AB/2\n' +
        '\n' +
        'Для AB/2 = 100 м → hmax ≈ 100 м\n' +
        '```\n\n' +
        
        '**Практические пределы:**\n' +
        '- Лёгкая аппаратура: до 50 м\n' +
        '- Стандартная: до 100-150 м\n' +
        '- Мощная: до 300-500 м\n\n' +
        
        '**7. КОЛИЧЕСТВО ТОЧЕК ВЭЗ:**\n\n' +
        
        '**Для площадных объектов:**\n' +
        '- Сеть: 50×50 м или 100×100 м\n' +
        '- Минимум: 3-5 точек на объект\n\n' +
        
        '**Для линейных объектов:**\n' +
        '- Через 50-100 м по оси трассы\n' +
        '- + в характерных точках\n\n' +
        
        '**8. РЕШАЕМЫЕ ЗАДАЧИ:**\n\n' +
        
        '**А. Поиск подземных вод:**\n' +
        '- Водоносные горизонты - проводящие зоны\n' +
        '- Определение глубины залегания УГВ\n' +
        '- Оценка минерализации\n\n' +
        
        '**Б. Картирование скальных грунтов:**\n' +
        '- Кровля коренных пород - резистивный слой\n' +
        '- Определение мощности рыхлых отложений\n\n' +
        
        '**В. Выявление зон:**\n' +
        '- Карста (высокое ρ)\n' +
        '- Обводнённых разломов (низкое ρ)\n' +
        '- Техногенных нарушений\n\n' +
        
        '**Г. Коррозионная активность:**\n' +
        '- ρ < 10 Ом·м - высокая\n' +
        '- 10-20 Ом·м - средняя\n' +
        '- >20 Ом·м - низкая\n\n' +
        
        '**9. ПРЕИМУЩЕСТВА ВЭЗ:**\n' +
        '- Высокая производительность (8-12 точек/день)\n' +
        '- Большая глубинность (до 300 м)\n' +
        '- Низкая стоимость\n' +
        '- Неразрушающий метод\n' +
        '- Работа в любое время года\n\n' +
        
        '**10. ОГРАНИЧЕНИЯ:**\n' +
        '- Неоднозначность интерпретации (эквивалентность)\n' +
        '- Зависимость от влажности грунтов\n' +
        '- Помехи от ЛЭП, трубопроводов, заборов\n' +
        '- Сложность в городских условиях\n' +
        '- Необходима калибровка по скважинам\n\n' +
        
        '**ВАЖНО:** ВЭЗ эффективно для горизонтально-слоистых сред',
      
      recommendedValues: {
        pointsPerHa: {
          value: 2,
          unit: 'точек/га',
          explanation: 'Сетка 50×50м'
        },
        maxDepth: {
          value: 100,
          unit: 'м',
          explanation: 'Стандартная глубинность'
        }
      }
    }
  ],
  
  calculateValues: (input: GeologicalInput) => {
    const area = input.buildingArea || 0;
    const linear = input.linearLength || 0;
    
    let pointsCount = 3;
    
    if (area > 0) {
      // Площадной объект
      pointsCount = Math.max(3, Math.ceil(area / 2500)); // точка на 50×50м
    } else if (linear > 0) {
      // Линейный объект
      pointsCount = Math.ceil(linear / 100);
    }
    
    return {
      vesPoints: {
        value: pointsCount,
        unit: 'точек',
        explanation: 'Точки ВЭЗ',
        confidence: 85
      },
      maxDepth: {
        value: 100,
        unit: 'м',
        explanation: 'Максимальная глубинность (AB/2)',
        confidence: 90
      }
    };
  },
  
  generateWorks: (input: GeologicalInput) => {
    const works: WorkItem[] = [];
    const values = block_45_01_ves.calculateValues!(input);
    
    const qty = typeof values.vesPoints.value === 'number'
      ? values.vesPoints.value
      : parseInt(String(values.vesPoints.value));
    
    works.push({
      workId: 'GEOPH-VES-01',
      name: 'Вертикальное электрическое зондирование (ВЭЗ)',
      description: 
        'Полевые работы установкой Шлюмберже. Измерение кажущегося сопротивления ' +
        'при разносах AB/2 от 1.5 до 100 м. Интерпретация кривых ВЭЗ',
      unit: 'точка',
      quantity: qty,
      category: 'recommended',
      module: 'geological',
      priority: 'РЕКОМЕНДУЕМЫЙ',
      normativeBase: 'СП РК 1.02-102-2014, п. 9.4',
      tags: ['геофизика', 'электроразведка'],
      priceTableCode: '1602-0602'
    });
    
    return works;
  }
};

/**
 * Блок 45.2: Электропрофилирование
 */
export const block_45_02_ep: InstructionBlock = {
  id: 'block-45-02-electrical-profiling',
  section: 'Раздел 45: Электроразведка',
  title: 'Электропрофилирование (ЭП)',
  description: 'Латеральное картирование неоднородностей',
  priority: 34,
  tags: ['геофизика', 'электроразведка', 'ЭП'],
  
  condition: (input: GeologicalInput) => {
    return (input.requiresGeophysics === true && 
            input.linearLength !== undefined) ||
           input.hasKarstRisk === true;
  },
  
  variants: [
    {
      id: 'variant-ep-standard',
      priority: 'СПРАВОЧНЫЙ',
      normative: {
        document: 'СП РК 1.02-102-2014',
        section: 'Электропрофилирование',
        priority: 'СПРАВОЧНЫЙ'
      },
      recommendation:
        '**ЭЛЕКТРОПРОФИЛИРОВАНИЕ (ЭП):**\n\n' +
        
        '**1. СУЩНОСТЬ МЕТОДА:**\n' +
        '- Перемещение установки вдоль профиля\n' +
        '- Постоянный разнос AB = const\n' +
        '- Измерение ρk через фиксированный шаг (5-10 м)\n' +
        '- Выявление латеральных неоднородностей\n\n' +
        
        '**2. ГЛУБИНА ИССЛЕДОВАНИЙ:**\n' +
        '```\n' +
        'h ≈ 0.5 × AB\n' +
        '\n' +
        'AB = 20 м → h ≈ 10 м\n' +
        'AB = 40 м → h ≈ 20 м\n' +
        '```\n\n' +
        
        '**3. ПРИМЕНЕНИЕ:**\n' +
        '- Поиск карстовых полостей (аномалии высокого ρ)\n' +
        '- Трассирование геологических границ\n' +
        '- Поиск погребённых объектов\n' +
        '- Обследование трасс трубопроводов\n\n' +
        
        '**ПРОИЗВОДИТЕЛЬНОСТЬ:** 1-3 км/день',
      
      recommendedValues: {
        profileStep: {
          value: 10,
          unit: 'м',
          explanation: 'Шаг измерений'
        }
      }
    }
  ],
  
  calculateValues: (input: GeologicalInput) => {
    const linear = input.linearLength || 0;
    
    return {
      profileLength: {
        value: linear,
        unit: 'п.м',
        explanation: 'Длина электропрофилирования',
        confidence: 85
      }
    };
  },
  
  generateWorks: (input: GeologicalInput) => {
    const works: WorkItem[] = [];
    const values = block_45_02_ep.calculateValues!(input);
    
    if (values.profileLength.value === 0) {
      return works;
    }
    
    const length = typeof values.profileLength.value === 'number'
      ? values.profileLength.value
      : parseFloat(String(values.profileLength.value));
    
    works.push({
      workId: 'GEOPH-EP-01',
      name: 'Электропрофилирование (ЭП)',
      description: 
        'Непрерывное профилирование установкой AB=const. ' +
        'Выявление латеральных неоднородностей',
      unit: 'п.м',
      quantity: length,
      category: 'optional',
      module: 'geological',
      priority: 'СПРАВОЧНЫЙ',
      normativeBase: 'СП РК 1.02-102-2014',
      tags: ['геофизика', 'электроразведка'],
      priceTableCode: '1602-0603'
    });
    
    return works;
  }
};

export const section45_blocks: InstructionBlock[] = [
  block_45_01_ves,
  block_45_02_ep
];

export default section45_blocks;
